## å†…å­˜åˆ†é…å™¨

[åŸæ–‡](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/)

[toc]

ç¨‹åºä¸­çš„æ•°æ®å’Œå˜é‡éƒ½ä¼šè¢«åˆ†é…åˆ°ç¨‹åºæ‰€åœ¨çš„è™šæ‹Ÿå†…å­˜ä¸­ï¼Œå†…å­˜ç©ºé—´åŒ…å«ä¸¤ä¸ªé‡è¦åŒºåŸŸï¼šæ ˆåŒºï¼ˆStackï¼‰å’Œå †åŒºï¼ˆHeapï¼‰ã€‚å‡½æ•°è°ƒç”¨çš„å‚æ•°ã€è¿”å›å€¼ä»¥åŠå±€éƒ¨å˜é‡å¤§éƒ½ä¼šè¢«åˆ†é…åˆ°æ ˆä¸Šï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¼šç”±ç¼–è¯‘å™¨è¿›è¡Œç®¡ç†ï¼›ä¸åŒç¼–ç¨‹è¯­è¨€ä½¿ç”¨ä¸åŒçš„æ–¹æ³•ç®¡ç†å †åŒºçš„å†…å­˜ï¼ŒC++ ç­‰ç¼–ç¨‹è¯­è¨€ä¼šç”±å·¥ç¨‹å¸ˆä¸»åŠ¨ç”³è¯·å’Œé‡Šæ”¾å†…å­˜ï¼ŒGo ä»¥åŠ Java ç­‰ç¼–ç¨‹è¯­è¨€ä¼šç”±å·¥ç¨‹å¸ˆå’Œç¼–è¯‘å™¨å…±åŒç®¡ç†ï¼Œå †ä¸­çš„å¯¹è±¡ç”±å†…å­˜åˆ†é…å™¨åˆ†é…å¹¶ç”±åƒåœ¾æ”¶é›†å™¨å›æ”¶ã€‚

### è®¾è®¡åŸç†

å†…å­˜ç®¡ç†ä¸€èˆ¬åŒ…å«ä¸‰ä¸ªä¸åŒçš„ç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯ç”¨æˆ·ç¨‹åºï¼ˆMutatorï¼‰ã€åˆ†é…å™¨ï¼ˆAllocatorï¼‰å’Œæ”¶é›†å™¨ï¼ˆCollector)ï¼Œå½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œå®ƒä¼šé€šè¿‡å†…å­˜åˆ†é…å™¨ç”³è¯·æ–°å†…å­˜ï¼Œè€Œåˆ†é…å™¨ä¼šè´Ÿè´£ä»å †ä¸­åˆå§‹åŒ–ç›¸åº”çš„å†…å­˜åŒºåŸŸã€‚

#### åˆ†é…æ–¹æ³•

ç¼–ç¨‹è¯­è¨€çš„å†…å­˜åˆ†é…å™¨ä¸€èˆ¬åŒ…å«ä¸¤ç§åˆ†é…æ–¹æ³•ï¼Œä¸€ç§æ˜¯çº¿æ€§åˆ†é…å™¨ï¼ˆSequential Allocatorï¼ŒBump Allocatorï¼‰ï¼Œå¦ä¸€ç§æ˜¯ç©ºé—²é“¾è¡¨åˆ†é…å™¨ï¼ˆFree-List Allocatorï¼‰ï¼Œè¿™ä¸¤ç§åˆ†é…æ–¹æ³•æœ‰ç€ä¸åŒçš„å®ç°æœºåˆ¶å’Œç‰¹æ€§ã€‚

##### çº¿æ€§åˆ†é…å™¨

çº¿æ€§åˆ†é…ï¼ˆBump Allocatorï¼‰æ˜¯ä¸€ç§é«˜æ•ˆçš„å†…å­˜åˆ†é…æ–¹æ³•ï¼Œä½†æ˜¯æœ‰è¾ƒå¤§çš„å±€é™æ€§ã€‚å½“æˆ‘ä»¬ä½¿ç”¨çº¿æ€§åˆ†é…å™¨æ—¶ï¼Œåªéœ€è¦åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªæŒ‡å‘å†…å­˜ç‰¹å®šä½ç½®çš„æŒ‡é’ˆï¼Œå¦‚æœç”¨æˆ·ç¨‹åºå‘åˆ†é…å™¨ç”³è¯·å†…å­˜ï¼Œåˆ†é…å™¨åªéœ€è¦æ£€æŸ¥å‰©ä½™çš„ç©ºé—²å†…å­˜ã€è¿”å›åˆ†é…çš„å†…å­˜åŒºåŸŸå¹¶ä¿®æ”¹æŒ‡é’ˆåœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œå³ç§»åŠ¨ä¸‹å›¾ä¸­çš„æŒ‡é’ˆï¼š

![2020-02-29-15829868066435-bump-allocator](../../../images/2020-02-29-15829868066435-bump-allocator.png)

è™½ç„¶çº¿æ€§åˆ†é…å™¨å®ç°ä¸ºå®ƒå¸¦æ¥äº†è¾ƒå¿«çš„æ‰§è¡Œé€Ÿåº¦ä»¥åŠè¾ƒä½çš„å®ç°å¤æ‚åº¦ï¼Œä½†æ˜¯çº¿æ€§åˆ†é…å™¨æ— æ³•åœ¨å†…å­˜è¢«é‡Šæ”¾æ—¶é‡ç”¨å†…å­˜ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¦‚æœå·²ç»åˆ†é…çš„å†…å­˜è¢«å›æ”¶ï¼Œçº¿æ€§åˆ†é…å™¨æ— æ³•é‡æ–°åˆ©ç”¨çº¢è‰²çš„å†…å­˜ï¼š

![2020-02-29-15829868066441-bump-allocator-reclaim-memory](../../../images/2020-02-29-15829868066441-bump-allocator-reclaim-memory.png)

å› ä¸ºçº¿æ€§åˆ†é…å™¨å…·æœ‰ä¸Šè¿°ç‰¹æ€§ï¼Œæ‰€ä»¥éœ€è¦ä¸åˆé€‚çš„åƒåœ¾å›æ”¶ç®—æ³•é…åˆä½¿ç”¨ï¼Œä¾‹å¦‚ï¼šæ ‡è®°å‹ç¼©ï¼ˆMark-Compactï¼‰ã€å¤åˆ¶å›æ”¶ï¼ˆCopying GCï¼‰å’Œåˆ†ä»£å›æ”¶ï¼ˆGenerational GCï¼‰ç­‰ç®—æ³•ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡æ‹·è´çš„æ–¹å¼æ•´ç†å­˜æ´»å¯¹è±¡çš„ç¢ç‰‡ï¼Œå°†ç©ºé—²å†…å­˜å®šæœŸåˆå¹¶ï¼Œè¿™æ ·å°±èƒ½åˆ©ç”¨çº¿æ€§åˆ†é…å™¨çš„æ•ˆç‡æå‡å†…å­˜åˆ†é…å™¨çš„æ€§èƒ½äº†ã€‚

å› ä¸ºçº¿æ€§åˆ†é…å™¨éœ€è¦ä¸å…·æœ‰æ‹·è´ç‰¹æ€§çš„åƒåœ¾å›æ”¶ç®—æ³•é…åˆï¼Œæ‰€ä»¥ C å’Œ C++ ç­‰éœ€è¦ç›´æ¥å¯¹å¤–æš´éœ²æŒ‡é’ˆçš„è¯­è¨€å°±æ— æ³•ä½¿ç”¨è¯¥ç­–ç•¥ã€‚

##### ç©ºé—²åˆ—è¡¨åˆ†é…å™¨

ç©ºé—²é“¾è¡¨åˆ†é…å™¨ï¼ˆFree-List Allocatorï¼‰å¯ä»¥é‡ç”¨å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜ï¼Œå®ƒåœ¨å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªç±»ä¼¼é“¾è¡¨çš„æ•°æ®ç»“æ„ã€‚å½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œç©ºé—²é“¾è¡¨åˆ†é…å™¨ä¼šä¾æ¬¡éå†ç©ºé—²çš„å†…å­˜å—ï¼Œæ‰¾åˆ°è¶³å¤Ÿå¤§çš„å†…å­˜ï¼Œç„¶åç”³è¯·æ–°çš„èµ„æºå¹¶ä¿®æ”¹é“¾è¡¨ï¼š

![2020-02-29-15829868066446-free-list-allocator](../../../images/2020-02-29-15829868066446-free-list-allocator.png)

å› ä¸ºä¸åŒçš„å†…å­˜å—é€šè¿‡æŒ‡é’ˆæ„æˆäº†é“¾è¡¨ï¼Œæ‰€ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼çš„åˆ†é…å™¨å¯ä»¥é‡æ–°åˆ©ç”¨å›æ”¶çš„èµ„æºï¼Œä½†æ˜¯å› ä¸ºåˆ†é…å†…å­˜æ—¶éœ€è¦éå†é“¾è¡¨ï¼Œæ‰€ä»¥å®ƒçš„æ—¶é—´å¤æ‚åº¦æ˜¯ ğ‘‚(ğ‘›)O(n)ã€‚ç©ºé—²é“¾è¡¨åˆ†é…å™¨å¯ä»¥é€‰æ‹©ä¸åŒçš„ç­–ç•¥åœ¨é“¾è¡¨ä¸­çš„å†…å­˜å—ä¸­è¿›è¡Œé€‰æ‹©ï¼Œæœ€å¸¸è§çš„æ˜¯ä»¥ä¸‹å››ç§ï¼š

- é¦–æ¬¡é€‚åº”ï¼ˆFirst-Fitï¼‰â€” ä»é“¾è¡¨å¤´å¼€å§‹éå†ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§å°å¤§äºç”³è¯·å†…å­˜çš„å†…å­˜å—ï¼›
- å¾ªç¯é¦–æ¬¡é€‚åº”ï¼ˆNext-Fitï¼‰â€” ä»ä¸Šæ¬¡éå†çš„ç»“æŸä½ç½®å¼€å§‹éå†ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§å°å¤§äºç”³è¯·å†…å­˜çš„å†…å­˜å—ï¼›
- æœ€ä¼˜é€‚åº”ï¼ˆBest-Fitï¼‰â€” ä»é“¾è¡¨å¤´éå†æ•´ä¸ªé“¾è¡¨ï¼Œé€‰æ‹©æœ€åˆé€‚çš„å†…å­˜å—ï¼›
- éš”ç¦»é€‚åº”ï¼ˆSegregated-Fitï¼‰â€” å°†å†…å­˜åˆ†å‰²æˆå¤šä¸ªé“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨ä¸­çš„å†…å­˜å—å¤§å°ç›¸åŒï¼Œç”³è¯·å†…å­˜æ—¶å…ˆæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„é“¾è¡¨ï¼Œå†ä»é“¾è¡¨ä¸­é€‰æ‹©åˆé€‚çš„å†…å­˜å—ï¼›

Go è¯­è¨€ä½¿ç”¨çš„å†…å­˜åˆ†é…ç­–ç•¥ä¸ç¬¬å››ç§ç­–ç•¥æœ‰äº›ç›¸ä¼¼ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹å›¾äº†è§£è¯¥ç­–ç•¥çš„åŸç†ï¼š

![2020-02-29-15829868066452-segregated-list](../../../images/2020-02-29-15829868066452-segregated-list.png)

è¯¥ç­–ç•¥ä¼šå°†å†…å­˜åˆ†å‰²æˆç”± 4ã€8ã€16ã€32 å­—èŠ‚çš„å†…å­˜å—ç»„æˆçš„é“¾è¡¨ï¼Œå½“æˆ‘ä»¬å‘å†…å­˜åˆ†é…å™¨ç”³è¯· 8 å­—èŠ‚çš„å†…å­˜æ—¶ï¼Œå®ƒä¼šåœ¨ä¸Šå›¾ä¸­æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ç©ºé—²å†…å­˜å—å¹¶è¿”å›ã€‚éš”ç¦»é€‚åº”çš„åˆ†é…ç­–ç•¥å‡å°‘äº†éœ€è¦éå†çš„å†…å­˜å—æ•°é‡ï¼Œæé«˜äº†å†…å­˜åˆ†é…çš„æ•ˆç‡ã€‚

#### åˆ†çº§åˆ†é…

çº¿ç¨‹ç¼“å­˜åˆ†é…ï¼ˆThread-Caching Mallocï¼ŒTCMallocï¼‰æ˜¯ç”¨äºåˆ†é…å†…å­˜çš„æœºåˆ¶ï¼Œå®ƒæ¯” glibc ä¸­çš„ `malloc` è¿˜è¦å¿«å¾ˆå¤šã€‚Go è¯­è¨€çš„å†…å­˜åˆ†é…å™¨å°±å€Ÿé‰´äº† TCMalloc çš„è®¾è®¡å®ç°é«˜é€Ÿçš„å†…å­˜åˆ†é…ï¼Œå®ƒçš„æ ¸å¿ƒç†å¿µæ˜¯ä½¿ç”¨å¤šçº§ç¼“å­˜å°†å¯¹è±¡æ ¹æ®å¤§å°åˆ†ç±»ï¼Œå¹¶æŒ‰ç…§ç±»åˆ«å®æ–½ä¸åŒçš„åˆ†é…ç­–ç•¥ã€‚

##### å¯¹è±¡å¤§å°

Go è¯­è¨€çš„å†…å­˜åˆ†é…å™¨ä¼šæ ¹æ®ç”³è¯·åˆ†é…çš„å†…å­˜å¤§å°é€‰æ‹©ä¸åŒçš„å¤„ç†é€»è¾‘ï¼Œè¿è¡Œæ—¶æ ¹æ®å¯¹è±¡çš„å¤§å°å°†å¯¹è±¡åˆ†æˆå¾®å¯¹è±¡ã€å°å¯¹è±¡å’Œå¤§å¯¹è±¡ä¸‰ç§ï¼š

|  ç±»åˆ«  |     å¤§å°      |
| :----: | :-----------: |
| å¾®å¯¹è±¡ |  `(0, 16B)`   |
| å°å¯¹è±¡ | `[16B, 32KB]` |
| å¤§å¯¹è±¡ | `(32KB, +âˆ)`  |

å› ä¸ºç¨‹åºä¸­çš„ç»å¤§å¤šæ•°å¯¹è±¡çš„å¤§å°éƒ½åœ¨ 32KB ä»¥ä¸‹ï¼Œè€Œç”³è¯·çš„å†…å­˜å¤§å°å½±å“ Go è¯­è¨€è¿è¡Œæ—¶åˆ†é…å†…å­˜çš„è¿‡ç¨‹å’Œå¼€é”€ï¼Œæ‰€ä»¥åˆ†åˆ«å¤„ç†å¤§å¯¹è±¡å’Œå°å¯¹è±¡æœ‰åˆ©äºæé«˜å†…å­˜åˆ†é…å™¨çš„æ€§èƒ½ã€‚

##### å¤šçº§ç¼“å­˜

å†…å­˜åˆ†é…å™¨ä¸ä»…ä¼šåŒºåˆ«å¯¹å¾…å¤§å°ä¸åŒçš„å¯¹è±¡ï¼Œè¿˜ä¼šå°†å†…å­˜åˆ†æˆä¸åŒçš„çº§åˆ«åˆ†åˆ«ç®¡ç†ï¼ŒTCMalloc å’Œ Go è¿è¡Œæ—¶åˆ†é…å™¨éƒ½ä¼šå¼•å…¥çº¿ç¨‹ç¼“å­˜ï¼ˆThread Cacheï¼‰ã€ä¸­å¿ƒç¼“å­˜ï¼ˆCentral Cacheï¼‰å’Œé¡µå †ï¼ˆPage Heapï¼‰ä¸‰ä¸ªç»„ä»¶åˆ†çº§ç®¡ç†å†…å­˜ï¼š

![2020-02-29-15829868066457-multi-level-cache](../../../images/2020-02-29-15829868066457-multi-level-cache.png)

çº¿ç¨‹ç¼“å­˜å±äºæ¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ï¼Œå®ƒèƒ½å¤Ÿæ»¡è¶³çº¿ç¨‹ä¸Šç»å¤§å¤šæ•°çš„å†…å­˜åˆ†é…éœ€æ±‚ï¼Œå› ä¸ºä¸æ¶‰åŠå¤šçº¿ç¨‹ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦ä½¿ç”¨äº’æ–¥é”æ¥ä¿æŠ¤å†…å­˜ï¼Œè¿™èƒ½å¤Ÿå‡å°‘é”ç«äº‰å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚å½“çº¿ç¨‹ç¼“å­˜ä¸èƒ½æ»¡è¶³éœ€æ±‚æ—¶ï¼Œè¿è¡Œæ—¶ä¼šä½¿ç”¨ä¸­å¿ƒç¼“å­˜ä½œä¸ºè¡¥å……è§£å†³å°å¯¹è±¡çš„å†…å­˜åˆ†é…ï¼Œåœ¨é‡åˆ° 32KB ä»¥ä¸Šçš„å¯¹è±¡æ—¶ï¼Œå†…å­˜åˆ†é…å™¨ä¼šé€‰æ‹©é¡µå †ç›´æ¥åˆ†é…å¤§å†…å­˜ã€‚

è¿™ç§å¤šå±‚çº§çš„å†…å­˜åˆ†é…è®¾è®¡ä¸è®¡ç®—æœºæ“ä½œç³»ç»Ÿä¸­çš„å¤šçº§ç¼“å­˜æœ‰äº›ç±»ä¼¼ï¼Œå› ä¸ºå¤šæ•°çš„å¯¹è±¡éƒ½æ˜¯å°å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡çº¿ç¨‹ç¼“å­˜å’Œä¸­å¿ƒç¼“å­˜æä¾›è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ï¼Œå‘ç°èµ„æºä¸è¶³æ—¶ä»ä¸Šä¸€çº§ç»„ä»¶ä¸­è·å–æ›´å¤šçš„å†…å­˜èµ„æºã€‚

#### è™šæ‹Ÿå†…å­˜å¸ƒå±€

##### çº¿æ€§å†…å­˜

Go è¯­è¨€ç¨‹åºçš„ 1.10 ç‰ˆæœ¬åœ¨å¯åŠ¨æ—¶ä¼šåˆå§‹åŒ–æ•´ç‰‡è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œå¦‚ä¸‹æ‰€ç¤ºçš„ä¸‰ä¸ªåŒºåŸŸ `spans`ã€`bitmap` å’Œ `arena` åˆ†åˆ«é¢„ç•™äº† 512MBã€16GB ä»¥åŠ 512GB çš„å†…å­˜ç©ºé—´ï¼Œè¿™äº›å†…å­˜å¹¶ä¸æ˜¯çœŸæ­£å­˜åœ¨çš„ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯è™šæ‹Ÿå†…å­˜ï¼š

![heap-before-go-1-10](../../../images/heap-before-go-1-10.png)

- `spans` åŒºåŸŸå­˜å‚¨äº†æŒ‡å‘å†…å­˜ç®¡ç†å•å…ƒ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) çš„æŒ‡é’ˆï¼Œæ¯ä¸ªå†…å­˜å•å…ƒä¼šç®¡ç†å‡ é¡µçš„å†…å­˜ç©ºé—´ï¼Œæ¯é¡µå¤§å°ä¸º 8KBï¼›
- `bitmap` ç”¨äºæ ‡è¯† `arena` åŒºåŸŸä¸­çš„é‚£äº›åœ°å€ä¿å­˜äº†å¯¹è±¡ï¼Œä½å›¾ä¸­çš„æ¯ä¸ªå­—èŠ‚éƒ½ä¼šè¡¨ç¤ºå †åŒºä¸­çš„ 32 å­—èŠ‚æ˜¯å¦ç©ºé—²ï¼›
- `arena` åŒºåŸŸæ˜¯çœŸæ­£çš„å †åŒºï¼Œè¿è¡Œæ—¶ä¼šå°† 8KB çœ‹åšä¸€é¡µï¼Œè¿™äº›å†…å­˜é¡µä¸­å­˜å‚¨äº†æ‰€æœ‰åœ¨å †ä¸Šåˆå§‹åŒ–çš„å¯¹è±¡ï¼›

å¯¹äºä»»æ„ä¸€ä¸ªåœ°å€ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æ ¹æ® `arena` çš„åŸºåœ°å€è®¡ç®—è¯¥åœ°å€æ‰€åœ¨çš„é¡µæ•°å¹¶é€šè¿‡ `spans` æ•°ç»„è·å¾—ç®¡ç†è¯¥ç‰‡å†…å­˜çš„ç®¡ç†å•å…ƒ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ï¼Œ`spans` æ•°ç»„ä¸­å¤šä¸ªè¿ç»­çš„ä½ç½®å¯èƒ½å¯¹åº”åŒä¸€ä¸ª [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) ç»“æ„ã€‚

Go è¯­è¨€åœ¨åƒåœ¾å›æ”¶æ—¶ä¼šæ ¹æ®æŒ‡é’ˆçš„åœ°å€åˆ¤æ–­å¯¹è±¡æ˜¯å¦åœ¨å †ä¸­ï¼Œå¹¶é€šè¿‡ä¸Šä¸€æ®µä¸­ä»‹ç»çš„è¿‡ç¨‹æ‰¾åˆ°ç®¡ç†è¯¥å¯¹è±¡çš„ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ã€‚è¿™äº›éƒ½å»ºç«‹åœ¨**å †åŒºçš„å†…å­˜æ˜¯è¿ç»­çš„**è¿™ä¸€å‡è®¾ä¸Šã€‚è¿™ç§è®¾è®¡è™½ç„¶ç®€å•å¹¶ä¸”æ–¹ä¾¿ï¼Œä½†æ˜¯åœ¨ C å’Œ Go æ··åˆä½¿ç”¨æ—¶ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼š

1. åˆ†é…çš„å†…å­˜åœ°å€ä¼šå‘ç”Ÿå†²çªï¼Œå¯¼è‡´å †çš„åˆå§‹åŒ–å’Œæ‰©å®¹å¤±è´¥
2. æ²¡æœ‰è¢«é¢„ç•™çš„å¤§å—å†…å­˜å¯èƒ½ä¼šè¢«åˆ†é…ç»™ C è¯­è¨€çš„äºŒè¿›åˆ¶ï¼Œå¯¼è‡´æ‰©å®¹åçš„å †ä¸è¿ç»­

çº¿æ€§çš„å †å†…å­˜éœ€è¦é¢„ç•™å¤§å—çš„å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯ç”³è¯·å¤§å—çš„å†…å­˜ç©ºé—´è€Œä¸ä½¿ç”¨æ˜¯ä¸åˆ‡å®é™…çš„ï¼Œä¸é¢„ç•™å†…å­˜ç©ºé—´å´ä¼šåœ¨ç‰¹æ®Šåœºæ™¯ä¸‹é€ æˆç¨‹åºå´©æºƒã€‚è™½ç„¶è¿ç»­å†…å­˜çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯è¿™äº›é—®é¢˜ä¹Ÿæ²¡æœ‰åŠæ³•å¿½ç•¥ã€‚

##### ç¨€ç–å†…å­˜

ç¨€ç–å†…å­˜æ˜¯ Go è¯­è¨€åœ¨ 1.11 ä¸­æå‡ºçš„æ–¹æ¡ˆï¼Œä½¿ç”¨ç¨€ç–çš„å†…å­˜å¸ƒå±€ä¸ä»…èƒ½ç§»é™¤å †å¤§å°çš„ä¸Šé™ï¼Œè¿˜èƒ½è§£å†³ C å’Œ Go æ··åˆä½¿ç”¨æ—¶çš„åœ°å€ç©ºé—´å†²çªé—®é¢˜ã€‚ä¸è¿‡å› ä¸ºåŸºäºç¨€ç–å†…å­˜çš„å†…å­˜ç®¡ç†å¤±å»äº†å†…å­˜çš„è¿ç»­æ€§è¿™ä¸€å‡è®¾ï¼Œè¿™ä¹Ÿä½¿å†…å­˜ç®¡ç†å˜å¾—æ›´åŠ å¤æ‚ï¼š
![2020-02-29-15829868066468-heap-after-go-1-11](../../../images/2020-02-29-15829868066468-heap-after-go-1-11.png)

è¿è¡Œæ—¶ä½¿ç”¨äºŒç»´çš„ [`runtime.heapArena`](https://draveness.me/golang/tree/runtime.heapArena) æ•°ç»„ç®¡ç†æ‰€æœ‰çš„å†…å­˜ï¼Œæ¯ä¸ªå•å…ƒéƒ½ä¼šç®¡ç† 64MB çš„å†…å­˜ç©ºé—´ï¼š

```go
type heapArena struct {
	bitmap       [heapArenaBitmapBytes]byte
	spans        [pagesPerArena]*mspan
	pageInUse    [pagesPerArena / 8]uint8
	pageMarks    [pagesPerArena / 8]uint8
	pageSpecials [pagesPerArena / 8]uint8
	checkmarks   *checkmarksMap
	zeroedBase   uintptr
}
```

è¯¥ç»“æ„ä½“ä¸­çš„ `bitmap` å’Œ `spans` ä¸çº¿æ€§å†…å­˜ä¸­çš„ `bitmap` å’Œ `spans` åŒºåŸŸä¸€ä¸€å¯¹åº”ï¼Œ`zeroedBase` å­—æ®µæŒ‡å‘äº†è¯¥ç»“æ„ä½“ç®¡ç†çš„å†…å­˜çš„åŸºåœ°å€ã€‚ä¸Šè¿°è®¾è®¡å°†åŸæœ‰çš„è¿ç»­å¤§å†…å­˜åˆ‡åˆ†æˆç¨€ç–çš„å°å†…å­˜ï¼Œè€Œç”¨äºç®¡ç†è¿™äº›å†…å­˜çš„å…ƒä¿¡æ¯ä¹Ÿè¢«åˆ‡æˆäº†å°å—ã€‚

ä¸åŒå¹³å°å’Œæ¶æ„çš„äºŒç»´æ•°ç»„å¤§å°å¯èƒ½å®Œå…¨ä¸åŒï¼Œå¦‚æœæˆ‘ä»¬çš„ Go è¯­è¨€æœåŠ¡åœ¨ Linux çš„ x86-64 æ¶æ„ä¸Šè¿è¡Œï¼ŒäºŒç»´æ•°ç»„çš„ä¸€ç»´å¤§å°ä¼šæ˜¯ 1ï¼Œè€ŒäºŒç»´å¤§å°æ˜¯ 4,194,304ï¼Œå› ä¸ºæ¯ä¸€ä¸ªæŒ‡é’ˆå ç”¨ 8 å­—èŠ‚çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥å…ƒä¿¡æ¯çš„æ€»å¤§å°ä¸º 32MBã€‚ç”±äºæ¯ä¸ª [`runtime.heapArena`](https://draveness.me/golang/tree/runtime.heapArena) éƒ½ä¼šç®¡ç† 64MB çš„å†…å­˜ï¼Œæ•´ä¸ªå †åŒºæœ€å¤šå¯ä»¥ç®¡ç† 256TB çš„å†…å­˜ï¼Œè¿™æ¯”ä¹‹å‰çš„ 512GB å¤šå¥½å‡ ä¸ªæ•°é‡çº§ã€‚

#### åœ°å€ç©ºé—´

å› ä¸ºæ‰€æœ‰çš„å†…å­˜æœ€ç»ˆéƒ½æ˜¯è¦ä»æ“ä½œç³»ç»Ÿä¸­ç”³è¯·çš„ï¼Œæ‰€ä»¥ Go è¯­è¨€çš„è¿è¡Œæ—¶æ„å»ºäº†æ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†æŠ½è±¡å±‚ï¼Œè¯¥æŠ½è±¡å±‚å°†è¿è¡Œæ—¶ç®¡ç†çš„åœ°å€ç©ºé—´åˆ†æˆä»¥ä¸‹å››ç§çŠ¶æ€ï¼š

|    çŠ¶æ€    |                             è§£é‡Š                             |
| :--------: | :----------------------------------------------------------: |
|   `None`   |         å†…å­˜æ²¡æœ‰è¢«ä¿ç•™æˆ–è€…æ˜ å°„ï¼Œæ˜¯åœ°å€ç©ºé—´çš„é»˜è®¤çŠ¶æ€         |
| `Reserved` |        è¿è¡Œæ—¶æŒæœ‰è¯¥åœ°å€ç©ºé—´ï¼Œä½†æ˜¯è®¿é—®è¯¥å†…å­˜ä¼šå¯¼è‡´é”™è¯¯        |
| `Prepared` | å†…å­˜è¢«ä¿ç•™ï¼Œä¸€èˆ¬æ²¡æœ‰å¯¹åº”çš„ç‰©ç†å†…å­˜è®¿é—®è¯¥ç‰‡å†…å­˜çš„è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„å¯ä»¥å¿«é€Ÿè½¬æ¢åˆ° `Ready` çŠ¶æ€ |
|  `Ready`   |                        å¯ä»¥è¢«å®‰å…¨è®¿é—®                        |

æ¯ä¸ªä¸åŒçš„æ“ä½œç³»ç»Ÿéƒ½ä¼šåŒ…å«ä¸€ç»„ç”¨äºç®¡ç†å†…å­˜çš„ç‰¹å®šæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯ä»¥è®©å†…å­˜åœ°å€ç©ºé—´åœ¨ä¸åŒçš„çŠ¶æ€ä¹‹é—´è½¬æ¢ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹å›¾äº†è§£ä¸åŒçŠ¶æ€ä¹‹é—´çš„è½¬æ¢è¿‡ç¨‹ï¼š

![2020-02-29-15829868066474-memory-regions-states-and-transitions](../../../images/2020-02-29-15829868066474-memory-regions-states-and-transitions.png)

è¿è¡Œæ—¶ä¸­åŒ…å«å¤šä¸ªæ“ä½œç³»ç»Ÿå®ç°çš„çŠ¶æ€è½¬æ¢æ–¹æ³•ï¼Œæ‰€æœ‰çš„å®ç°éƒ½åŒ…å«åœ¨ä»¥ `mem_` å¼€å¤´çš„æ–‡ä»¶ä¸­ï¼Œæœ¬èŠ‚å°†ä»‹ç» Linux æ“ä½œç³»ç»Ÿå¯¹ä¸Šå›¾ä¸­æ–¹æ³•çš„å®ç°ï¼š

- [`runtime.sysAlloc`](https://draveness.me/golang/tree/runtime.sysAlloc) ä¼šä»æ“ä½œç³»ç»Ÿä¸­è·å–ä¸€å¤§å—å¯ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå¯èƒ½ä¸ºå‡ ç™¾ KB æˆ–è€…å‡  MBï¼›
- [`runtime.sysFree`](https://draveness.me/golang/tree/runtime.sysFree) ä¼šåœ¨ç¨‹åºå‘ç”Ÿå†…å­˜ä¸è¶³ï¼ˆOut-of Memoryï¼ŒOOMï¼‰æ—¶è°ƒç”¨å¹¶æ— æ¡ä»¶åœ°è¿”å›å†…å­˜ï¼›
- [`runtime.sysReserve`](https://draveness.me/golang/tree/runtime.sysReserve) ä¼šä¿ç•™æ“ä½œç³»ç»Ÿä¸­çš„ä¸€ç‰‡å†…å­˜åŒºåŸŸï¼Œè®¿é—®è¿™ç‰‡å†…å­˜ä¼šè§¦å‘å¼‚å¸¸ï¼›
- [`runtime.sysMap`](https://draveness.me/golang/tree/runtime.sysMap) ä¿è¯å†…å­˜åŒºåŸŸå¯ä»¥å¿«é€Ÿè½¬æ¢è‡³å°±ç»ªçŠ¶æ€ï¼›
- [`runtime.sysUsed`](https://draveness.me/golang/tree/runtime.sysUsed) é€šçŸ¥æ“ä½œç³»ç»Ÿåº”ç”¨ç¨‹åºéœ€è¦ä½¿ç”¨è¯¥å†…å­˜åŒºåŸŸï¼Œä¿è¯å†…å­˜åŒºåŸŸå¯ä»¥å®‰å…¨è®¿é—®ï¼›
- [`runtime.sysUnused`](https://draveness.me/golang/tree/runtime.sysUnused) é€šçŸ¥æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜å¯¹åº”çš„ç‰©ç†å†…å­˜å·²ç»ä¸å†éœ€è¦ï¼Œå¯ä»¥é‡ç”¨ç‰©ç†å†…å­˜ï¼›
- [`runtime.sysFault`](https://draveness.me/golang/tree/runtime.sysFault) å°†å†…å­˜åŒºåŸŸè½¬æ¢æˆä¿ç•™çŠ¶æ€ï¼Œä¸»è¦ç”¨äºè¿è¡Œæ—¶çš„è°ƒè¯•ï¼›

è¿è¡Œæ—¶ä½¿ç”¨ Linux æä¾›çš„ `mmap`ã€`munmap` å’Œ `madvise` ç­‰ç³»ç»Ÿè°ƒç”¨å®ç°äº†æ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†æŠ½è±¡å±‚ï¼ŒæŠ¹å¹³äº†ä¸åŒæ“ä½œç³»ç»Ÿçš„å·®å¼‚ï¼Œä¸ºè¿è¡Œæ—¶æä¾›äº†æ›´åŠ æ–¹ä¾¿çš„æ¥å£ï¼Œé™¤äº† Linux ä¹‹å¤–ï¼Œè¿è¡Œæ—¶è¿˜å®ç°äº† BSDã€Darwinã€Plan9 ä»¥åŠ Windows ç­‰å¹³å°ä¸ŠæŠ½è±¡å±‚ã€‚

### å†…å­˜ç®¡ç†ç»„ä»¶

Go è¯­è¨€çš„å†…å­˜åˆ†é…å™¨åŒ…å«å†…å­˜ç®¡ç†å•å…ƒã€çº¿ç¨‹ç¼“å­˜ã€ä¸­å¿ƒç¼“å­˜å’Œé¡µå †å‡ ä¸ªé‡è¦ç»„ä»¶ã€‚

![2020-02-29-15829868066479-go-memory-layout](../../../images/2020-02-29-15829868066479-go-memory-layout.png)

æ‰€æœ‰çš„ Go è¯­è¨€ç¨‹åºéƒ½ä¼šåœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–å¦‚ä¸Šå›¾æ‰€ç¤ºçš„å†…å­˜å¸ƒå±€ï¼Œæ¯ä¸€ä¸ªå¤„ç†å™¨éƒ½ä¼šåˆ†é…ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜ [`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache) ç”¨äºå¤„ç†å¾®å¯¹è±¡å’Œå°å¯¹è±¡çš„åˆ†é…ï¼Œå®ƒä»¬ä¼šæŒæœ‰å†…å­˜ç®¡ç†å•å…ƒ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ã€‚

æ¯ä¸ªç±»å‹çš„å†…å­˜ç®¡ç†å•å…ƒéƒ½ä¼šç®¡ç†ç‰¹å®šå¤§å°çš„å¯¹è±¡ï¼Œå½“å†…å­˜ç®¡ç†å•å…ƒä¸­ä¸å­˜åœ¨ç©ºé—²å¯¹è±¡æ—¶ï¼Œå®ƒä»¬ä¼šä» [`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap) æŒæœ‰çš„ 134 ä¸ªä¸­å¿ƒç¼“å­˜ [`runtime.mcentral`](https://draveness.me/golang/tree/runtime.mcentral) ä¸­è·å–æ–°çš„å†…å­˜å•å…ƒï¼Œä¸­å¿ƒç¼“å­˜å±äºå…¨å±€çš„å †ç»“æ„ä½“ [`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap)ï¼Œå®ƒä¼šä»æ“ä½œç³»ç»Ÿä¸­ç”³è¯·å†…å­˜ã€‚

åœ¨ amd64 çš„ Linux æ“ä½œç³»ç»Ÿä¸Šï¼Œ[`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap) ä¼šæŒæœ‰ 4,194,304 [`runtime.heapArena`](https://draveness.me/golang/tree/runtime.heapArena)ï¼Œæ¯ä¸ª [`runtime.heapArena`](https://draveness.me/golang/tree/runtime.heapArena) éƒ½ä¼šç®¡ç† 64MB çš„å†…å­˜ï¼Œå•ä¸ª Go è¯­è¨€ç¨‹åºçš„å†…å­˜ä¸Šé™ä¹Ÿå°±æ˜¯ 256TBã€‚

#### å†…å­˜ç®¡ç†å•å…ƒ

[`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) æ˜¯ Go è¯­è¨€å†…å­˜ç®¡ç†çš„åŸºæœ¬å•å…ƒï¼Œè¯¥ç»“æ„ä½“ä¸­åŒ…å« `next` å’Œ `prev` ä¸¤ä¸ªå­—æ®µï¼Œå®ƒä»¬åˆ†åˆ«æŒ‡å‘äº†å‰ä¸€ä¸ªå’Œåä¸€ä¸ª [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ï¼š

```go
type mspan struct {
	next *mspan
	prev *mspan
	...
}
```

ä¸²è”åçš„ä¸Šè¿°ç»“æ„ä½“ä¼šæ„æˆå¦‚ä¸‹åŒå‘é“¾è¡¨ï¼Œè¿è¡Œæ—¶ä¼šä½¿ç”¨ [`runtime.mSpanList`](https://draveness.me/golang/tree/runtime.mSpanList) å­˜å‚¨åŒå‘é“¾è¡¨çš„å¤´ç»“ç‚¹å’Œå°¾èŠ‚ç‚¹å¹¶åœ¨çº¿ç¨‹ç¼“å­˜ä»¥åŠä¸­å¿ƒç¼“å­˜ä¸­ä½¿ç”¨ã€‚

![2020-02-29-15829868066485-mspan-and-linked-list](../../../images/go/2020-02-29-15829868066485-mspan-and-linked-list.png)

##### é¡µå’Œå†…å­˜

æ¯ä¸ª [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) éƒ½ç®¡ç† `npages` ä¸ªå¤§å°ä¸º 8KB çš„é¡µï¼Œè¿™é‡Œçš„é¡µä¸æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„å†…å­˜é¡µï¼Œå®ƒä»¬æ˜¯æ“ä½œç³»ç»Ÿå†…å­˜é¡µçš„æ•´æ•°å€ï¼Œè¯¥ç»“æ„ä½“ä¼šä½¿ç”¨ä¸‹é¢è¿™äº›å­—æ®µæ¥ç®¡ç†å†…å­˜é¡µçš„åˆ†é…å’Œå›æ”¶ï¼š

```go
type mspan struct {
	startAddr uintptr // èµ·å§‹åœ°å€
	npages    uintptr // é¡µæ•°
	freeindex uintptr

	allocBits  *gcBits
	gcmarkBits *gcBits
	allocCache uint64
	...
}
```

- `startAddr` å’Œ `npages` â€” ç¡®å®šè¯¥ç»“æ„ä½“ç®¡ç†çš„å¤šä¸ªé¡µæ‰€åœ¨çš„å†…å­˜ï¼Œæ¯ä¸ªé¡µçš„å¤§å°éƒ½æ˜¯ 8KBï¼›
- `freeindex` â€” æ‰«æé¡µä¸­ç©ºé—²å¯¹è±¡çš„åˆå§‹ç´¢å¼•ï¼›
- `allocBits` å’Œ `gcmarkBits` â€” åˆ†åˆ«ç”¨äºæ ‡è®°å†…å­˜çš„å ç”¨å’Œå›æ”¶æƒ…å†µï¼›
- `allocCache` â€” `allocBits` çš„è¡¥ç ï¼Œå¯ä»¥ç”¨äºå¿«é€ŸæŸ¥æ‰¾å†…å­˜ä¸­æœªè¢«ä½¿ç”¨çš„å†…å­˜ï¼›

[`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) ä¼šä»¥ä¸¤ç§ä¸åŒçš„è§†è§’çœ‹å¾…ç®¡ç†çš„å†…å­˜ï¼Œå½“ç»“æ„ä½“ç®¡ç†çš„å†…å­˜ä¸è¶³æ—¶ï¼Œè¿è¡Œæ—¶ä¼šä»¥é¡µä¸ºå•ä½å‘å †ç”³è¯·å†…å­˜ï¼š

![2020-02-29-15829868066492-mspan-and-pages](../../../images/go/2020-02-29-15829868066492-mspan-and-pages.png)

å½“ç”¨æˆ·ç¨‹åºæˆ–è€…çº¿ç¨‹å‘ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) ç”³è¯·å†…å­˜æ—¶ï¼Œå®ƒä¼šä½¿ç”¨ `allocCache` å­—æ®µä»¥å¯¹è±¡ä¸ºå•ä½åœ¨ç®¡ç†çš„å†…å­˜ä¸­å¿«é€ŸæŸ¥æ‰¾å¾…åˆ†é…çš„ç©ºé—´ï¼š

![2020-02-29-15829868066499-mspan-and-objects](../../../images/go/2020-02-29-15829868066499-mspan-and-objects.png)

å¦‚æœæˆ‘ä»¬èƒ½åœ¨å†…å­˜ä¸­æ‰¾åˆ°ç©ºé—²çš„å†…å­˜å•å…ƒä¼šç›´æ¥è¿”å›ï¼Œå½“å†…å­˜ä¸­ä¸åŒ…å«ç©ºé—²çš„å†…å­˜æ—¶ï¼Œä¸Šä¸€çº§çš„ç»„ä»¶ [`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache) ä¼šä¸ºè°ƒç”¨ [`runtime.mcache.refill`](https://draveness.me/golang/tree/runtime.mcache.refill) æ›´æ–°å†…å­˜ç®¡ç†å•å…ƒä»¥æ»¡è¶³ä¸ºæ›´å¤šå¯¹è±¡åˆ†é…å†…å­˜çš„éœ€æ±‚ã€‚

##### çŠ¶æ€

è¿è¡Œæ—¶ä¼šä½¿ç”¨ [`runtime.mSpanStateBox`](https://draveness.me/golang/tree/runtime.mSpanStateBox) å­˜å‚¨å†…å­˜ç®¡ç†å•å…ƒçš„çŠ¶æ€ [`runtime.mSpanState`](https://draveness.me/golang/tree/runtime.mSpanState)ï¼š

```go
type mspan struct {
	...
	state       mSpanStateBox
	...
}
```

è¯¥çŠ¶æ€å¯èƒ½å¤„äº `mSpanDead`ã€`mSpanInUse`ã€`mSpanManual` å’Œ `mSpanFree` å››ç§æƒ…å†µã€‚å½“ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) åœ¨ç©ºé—²å †ä¸­ï¼Œå®ƒä¼šå¤„äº `mSpanFree` çŠ¶æ€ï¼›å½“ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) å·²ç»è¢«åˆ†é…æ—¶ï¼Œå®ƒä¼šå¤„äº `mSpanInUse`ã€`mSpanManual` çŠ¶æ€ï¼Œè¿è¡Œæ—¶ä¼šéµå¾ªä¸‹é¢çš„è§„åˆ™è½¬æ¢è¯¥çŠ¶æ€ï¼š

- åœ¨åƒåœ¾å›æ”¶çš„ä»»æ„é˜¶æ®µï¼Œå¯èƒ½ä» `mSpanFree` è½¬æ¢åˆ° `mSpanInUse` å’Œ `mSpanManual`ï¼›
- åœ¨åƒåœ¾å›æ”¶çš„æ¸…é™¤é˜¶æ®µï¼Œå¯èƒ½ä» `mSpanInUse` å’Œ `mSpanManual` è½¬æ¢åˆ° `mSpanFree`ï¼›
- åœ¨åƒåœ¾å›æ”¶çš„æ ‡è®°é˜¶æ®µï¼Œä¸èƒ½ä» `mSpanInUse` å’Œ `mSpanManual` è½¬æ¢åˆ° `mSpanFree`ï¼›

è®¾ç½® [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) çŠ¶æ€çš„æ“ä½œå¿…é¡»æ˜¯åŸå­æ€§çš„ä»¥é¿å…åƒåœ¾å›æ”¶é€ æˆçš„çº¿ç¨‹ç«äº‰é—®é¢˜ã€‚

##### è·¨åº¦ç±»

[`runtime.spanClass`](https://draveness.me/golang/tree/runtime.spanClass) æ˜¯ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) çš„è·¨åº¦ç±»ï¼Œå®ƒå†³å®šäº†å†…å­˜ç®¡ç†å•å…ƒä¸­å­˜å‚¨çš„å¯¹è±¡å¤§å°å’Œä¸ªæ•°ï¼š

```go
type mspan struct {
	...
	spanclass   spanClass
	...
}
```

Go è¯­è¨€çš„å†…å­˜ç®¡ç†æ¨¡å—ä¸­ä¸€å…±åŒ…å« 67 ç§è·¨åº¦ç±»ï¼Œæ¯ä¸€ä¸ªè·¨åº¦ç±»éƒ½ä¼šå­˜å‚¨ç‰¹å®šå¤§å°çš„å¯¹è±¡å¹¶ä¸”åŒ…å«ç‰¹å®šæ•°é‡çš„é¡µæ•°ä»¥åŠå¯¹è±¡ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½ä¼šè¢«é¢„é€‰è®¡ç®—å¥½å¹¶å­˜å‚¨åœ¨ [`runtime.class_to_size`](https://draveness.me/golang/tree/runtime.class_to_size) å’Œ [`runtime.class_to_allocnpages`](https://draveness.me/golang/tree/runtime.class_to_allocnpages) ç­‰å˜é‡ä¸­ï¼š

| class | bytes/obj | bytes/span | objects | tail waste | max waste |
| :---: | --------: | ---------: | ------: | :--------: | :-------: |
|   1   |         8 |       8192 |    1024 |     0      |  87.50%   |
|   2   |        16 |       8192 |     512 |     0      |  43.75%   |
|   3   |        24 |       8192 |     341 |     0      |  29.24%   |
|   4   |        32 |       8192 |     256 |     0      |  46.88%   |
|   5   |        48 |       8192 |     170 |     32     |  31.52%   |
|   6   |        64 |       8192 |     128 |     0      |  23.44%   |
|   7   |        80 |       8192 |     102 |     32     |  19.07%   |
|   â€¦   |         â€¦ |          â€¦ |       â€¦ |     â€¦      |     â€¦     |
|  67   |     32768 |      32768 |       1 |     0      |  12.50%   |

ä¸Šè¡¨å±•ç¤ºäº†å¯¹è±¡å¤§å°ä» 8B åˆ° 32KBï¼Œæ€»å…± 67 ç§è·¨åº¦ç±»çš„å¤§å°ã€å­˜å‚¨çš„å¯¹è±¡æ•°ä»¥åŠæµªè´¹çš„å†…å­˜ç©ºé—´ã€‚

ä»¥è¡¨ä¸­çš„ç¬¬å››ä¸ªè·¨åº¦ç±»ä¸ºä¾‹ï¼Œè·¨åº¦ç±»ä¸º 5 çš„ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) ä¸­å¯¹è±¡çš„å¤§å°ä¸Šé™ä¸º 48 å­—èŠ‚ã€ç®¡ç† 1 ä¸ªé¡µã€æœ€å¤šå¯ä»¥å­˜å‚¨ 170 ä¸ªå¯¹è±¡ã€‚å› ä¸ºå†…å­˜éœ€è¦æŒ‰ç…§é¡µè¿›è¡Œç®¡ç†ï¼Œæ‰€ä»¥åœ¨å°¾éƒ¨ä¼šæµªè´¹ 32 å­—èŠ‚çš„å†…å­˜ï¼Œå½“é¡µä¸­å­˜å‚¨çš„å¯¹è±¡éƒ½æ˜¯ 33 å­—èŠ‚æ—¶ï¼Œæœ€å¤šä¼šæµªè´¹ 31.52% çš„èµ„æºã€‚

é™¤äº†ä¸Šè¿° 67 ä¸ªè·¨åº¦ç±»ä¹‹å¤–ï¼Œè¿è¡Œæ—¶ä¸­è¿˜åŒ…å« ID ä¸º 0 çš„ç‰¹æ®Šè·¨åº¦ç±»ï¼Œå®ƒèƒ½å¤Ÿç®¡ç†å¤§äº 32KB çš„ç‰¹æ®Šå¯¹è±¡ã€‚

è·¨åº¦ç±»ä¸­é™¤äº†å­˜å‚¨ç±»åˆ«çš„ ID ä¹‹å¤–ï¼Œå®ƒè¿˜ä¼šå­˜å‚¨ä¸€ä¸ª `noscan` æ ‡è®°ä½ï¼Œè¯¥æ ‡è®°ä½è¡¨ç¤ºå¯¹è±¡æ˜¯å¦åŒ…å«æŒ‡é’ˆï¼Œåƒåœ¾å›æ”¶ä¼šå¯¹åŒ…å«æŒ‡é’ˆçš„ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) ç»“æ„ä½“è¿›è¡Œæ‰«æã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‡ ä¸ªå‡½æ•°å’Œæ–¹æ³•äº†è§£ ID å’Œæ ‡è®°ä½çš„åº•å±‚å­˜å‚¨æ–¹å¼ï¼š

```go
func makeSpanClass(sizeclass uint8, noscan bool) spanClass {
	return spanClass(sizeclass<<1) | spanClass(bool2int(noscan))
}

func (sc spanClass) sizeclass() int8 {
	return int8(sc >> 1)
}

func (sc spanClass) noscan() bool {
	return sc&1 != 0
}
```

[`runtime.spanClass`](https://draveness.me/golang/tree/runtime.spanClass) æ˜¯ä¸€ä¸ª `uint8` ç±»å‹çš„æ•´æ•°ï¼Œå®ƒçš„å‰ 7 ä½å­˜å‚¨ç€è·¨åº¦ç±»çš„ IDï¼Œæœ€åä¸€ä½è¡¨ç¤ºæ˜¯å¦åŒ…å«æŒ‡é’ˆã€‚

#### çº¿ç¨‹ç¼“å­˜

[`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache) æ˜¯ Go è¯­è¨€ä¸­çš„çº¿ç¨‹ç¼“å­˜ï¼Œå®ƒä¼šä¸çº¿ç¨‹ä¸Šçš„å¤„ç†å™¨ä¸€ä¸€ç»‘å®šï¼Œä¸»è¦ç”¨æ¥ç¼“å­˜ç”¨æˆ·ç¨‹åºç”³è¯·çš„å¾®å°å¯¹è±¡ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜éƒ½æŒæœ‰ 68 * 2 ä¸ª [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ï¼Œè¿™äº›å†…å­˜ç®¡ç†å•å…ƒéƒ½å­˜å‚¨åœ¨ç»“æ„ä½“çš„ `alloc` å­—æ®µä¸­ï¼š

![2020-02-29-15829868066512-mcache-and-mspans](../../../images/go/2020-02-29-15829868066512-mcache-and-mspans.png)

çº¿ç¨‹ç¼“å­˜åœ¨åˆšåˆšè¢«åˆå§‹åŒ–æ—¶æ˜¯ä¸åŒ…å« [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) çš„ï¼Œåªæœ‰å½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶æ‰ä¼šä»ä¸Šä¸€çº§ç»„ä»¶è·å–æ–°çš„ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) æ»¡è¶³å†…å­˜åˆ†é…çš„éœ€æ±‚ã€‚

##### åˆå§‹åŒ–

è¿è¡Œæ—¶åœ¨åˆå§‹åŒ–å¤„ç†å™¨æ—¶ä¼šè°ƒç”¨ [`runtime.allocmcache`](https://draveness.me/golang/tree/runtime.allocmcache) åˆå§‹åŒ–çº¿ç¨‹ç¼“å­˜ï¼Œè¯¥å‡½æ•°ä¼šåœ¨ç³»ç»Ÿæ ˆä¸­ä½¿ç”¨ [`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap) ä¸­çš„çº¿ç¨‹ç¼“å­˜åˆ†é…å™¨åˆå§‹åŒ–æ–°çš„ [`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache) ç»“æ„ä½“ï¼š

```go
func allocmcache() *mcache {
	var c *mcache
	systemstack(func() {
		lock(&mheap_.lock)
		c = (*mcache)(mheap_.cachealloc.alloc())
		c.flushGen = mheap_.sweepgen
		unlock(&mheap_.lock)
	})
	for i := range c.alloc {
		c.alloc[i] = &emptymspan
	}
	c.nextSample = nextSample()
	return c
}
```

åˆå§‹åŒ–åçš„ [`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache) ä¸­çš„æ‰€æœ‰ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) éƒ½æ˜¯ç©ºçš„å ä½ç¬¦ `emptymspan`ã€‚

##### æ›¿æ¢

[`runtime.mcache.refill`](https://draveness.me/golang/tree/runtime.mcache.refill) ä¼šä¸ºçº¿ç¨‹ç¼“å­˜è·å–ä¸€ä¸ªæŒ‡å®šè·¨åº¦ç±»çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œè¢«æ›¿æ¢çš„å•å…ƒä¸èƒ½åŒ…å«ç©ºé—²çš„å†…å­˜ç©ºé—´ï¼Œè€Œè·å–çš„å•å…ƒä¸­éœ€è¦è‡³å°‘åŒ…å«ä¸€ä¸ªç©ºé—²å¯¹è±¡ç”¨äºåˆ†é…å†…å­˜ï¼š

```go
func (c *mcache) refill(spc spanClass) {
	s := c.alloc[spc]
	s = mheap_.central[spc].mcentral.cacheSpan()
	c.alloc[spc] = s
}
```

è¯¥æ–¹æ³•ä¼šä»ä¸­å¿ƒç¼“å­˜ä¸­ç”³è¯·æ–°çš„ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) å­˜å‚¨åˆ°çº¿ç¨‹ç¼“å­˜ä¸­ï¼Œè¿™ä¹Ÿæ˜¯å‘çº¿ç¨‹ç¼“å­˜æ’å…¥å†…å­˜ç®¡ç†å•å…ƒçš„å”¯ä¸€æ–¹æ³•ã€‚

##### å¾®åˆ†é…å™¨

çº¿ç¨‹ç¼“å­˜ä¸­è¿˜åŒ…å«å‡ ä¸ªç”¨äºåˆ†é…å¾®å¯¹è±¡çš„å­—æ®µï¼Œä¸‹é¢çš„è¿™ä¸‰ä¸ªå­—æ®µç»„æˆäº†å¾®å¯¹è±¡åˆ†é…å™¨ï¼Œä¸“é—¨ç®¡ç† 16 å­—èŠ‚ä»¥ä¸‹çš„å¯¹è±¡ï¼š

```go
type mcache struct {
	tiny             uintptr
	tinyoffset       uintptr
	local_tinyallocs uintptr
}
```

å¾®åˆ†é…å™¨åªä¼šç”¨äºåˆ†é…éæŒ‡é’ˆç±»å‹çš„å†…å­˜ï¼Œä¸Šè¿°ä¸‰ä¸ªå­—æ®µä¸­ `tiny` ä¼šæŒ‡å‘å †ä¸­çš„ä¸€ç‰‡å†…å­˜ï¼Œ`tinyOffset` æ˜¯ä¸‹ä¸€ä¸ªç©ºé—²å†…å­˜æ‰€åœ¨çš„åç§»é‡ï¼Œæœ€åçš„ `local_tinyallocs` ä¼šè®°å½•å†…å­˜åˆ†é…å™¨ä¸­åˆ†é…çš„å¯¹è±¡ä¸ªæ•°ã€‚

#### ä¸­å¿ƒç¼“å­˜

[`runtime.mcentral`](https://draveness.me/golang/tree/runtime.mcentral) æ˜¯å†…å­˜åˆ†é…å™¨çš„ä¸­å¿ƒç¼“å­˜ï¼Œä¸çº¿ç¨‹ç¼“å­˜ä¸åŒï¼Œè®¿é—®ä¸­å¿ƒç¼“å­˜ä¸­çš„å†…å­˜ç®¡ç†å•å…ƒéœ€è¦ä½¿ç”¨äº’æ–¥é”ï¼š

```go
type mcentral struct {
	spanclass spanClass
	partial  [2]spanSet
	full     [2]spanSet
}
```

æ¯ä¸ªä¸­å¿ƒç¼“å­˜éƒ½ä¼šç®¡ç†æŸä¸ªè·¨åº¦ç±»çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œå®ƒä¼šåŒæ—¶æŒæœ‰ä¸¤ä¸ª [`runtime.spanSet`](https://draveness.me/golang/tree/runtime.spanSet)ï¼Œåˆ†åˆ«å­˜å‚¨åŒ…å«ç©ºé—²å¯¹è±¡å’Œä¸åŒ…å«ç©ºé—²å¯¹è±¡çš„å†…å­˜ç®¡ç†å•å…ƒã€‚

##### å†…å­˜ç®¡ç†å•å…ƒ

çº¿ç¨‹ç¼“å­˜ä¼šé€šè¿‡ä¸­å¿ƒç¼“å­˜çš„ [`runtime.mcentral.cacheSpan`](https://draveness.me/golang/tree/runtime.mcentral.cacheSpan) æ–¹æ³•è·å–æ–°çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œè¯¥æ–¹æ³•çš„å®ç°æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶åˆ†æˆä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

1. è°ƒç”¨ [`runtime.mcentral.partialSwept`](https://draveness.me/golang/tree/runtime.mcentral.partialSwept) ä»æ¸…ç†è¿‡çš„ã€åŒ…å«ç©ºé—²ç©ºé—´çš„ [`runtime.spanSet`](https://draveness.me/golang/tree/runtime.spanSet) ç»“æ„ä¸­æŸ¥æ‰¾å¯ä»¥ä½¿ç”¨çš„å†…å­˜ç®¡ç†å•å…ƒï¼›
2. è°ƒç”¨ [`runtime.mcentral.partialUnswept`](https://draveness.me/golang/tree/runtime.mcentral.partialUnswept) ä»æœªè¢«æ¸…ç†è¿‡çš„ã€æœ‰ç©ºé—²å¯¹è±¡çš„ [`runtime.spanSet`](https://draveness.me/golang/tree/runtime.spanSet) ç»“æ„ä¸­æŸ¥æ‰¾å¯ä»¥ä½¿ç”¨çš„å†…å­˜ç®¡ç†å•å…ƒï¼›
3. è°ƒç”¨ [`runtime.mcentral.fullUnswept`](https://draveness.me/golang/tree/runtime.mcentral.fullUnswept) è·å–æœªè¢«æ¸…ç†çš„ã€ä¸åŒ…å«ç©ºé—²ç©ºé—´çš„ [`runtime.spanSet`](https://draveness.me/golang/tree/runtime.spanSet) ä¸­è·å–å†…å­˜ç®¡ç†å•å…ƒå¹¶é€šè¿‡ [`runtime.mspan.sweep`](https://draveness.me/golang/tree/runtime.mspan.sweep) æ¸…ç†å®ƒçš„å†…å­˜ç©ºé—´ï¼›
4. è°ƒç”¨ [`runtime.mcentral.grow`](https://draveness.me/golang/tree/runtime.mcentral.grow) ä»å †ä¸­ç”³è¯·æ–°çš„å†…å­˜ç®¡ç†å•å…ƒï¼›
5. æ›´æ–°å†…å­˜ç®¡ç†å•å…ƒçš„ `allocCache` ç­‰å­—æ®µå¸®åŠ©å¿«é€Ÿåˆ†é…å†…å­˜ï¼›

é¦–å…ˆä¼šåœ¨ä¸­å¿ƒç¼“å­˜çš„ç©ºé—²é›†åˆä¸­æŸ¥æ‰¾å¯ç”¨çš„ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ï¼Œè¿è¡Œæ—¶æ€»æ˜¯ä¼šå…ˆä»è·å–æ¸…ç†è¿‡çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œåæ£€æŸ¥æœªæ¸…ç†çš„å†…å­˜ç®¡ç†å•å…ƒï¼š

```go
func (c *mcentral) cacheSpan() *mspan {
	sg := mheap_.sweepgen
	spanBudget := 100

	var s *mspan
	if s = c.partialSwept(sg).pop(); s != nil {
		goto havespan
	}

	for ; spanBudget >= 0; spanBudget-- {
		s = c.partialUnswept(sg).pop()
		if s == nil {
			break
		}
		if atomic.Load(&s.sweepgen) == sg-2 && atomic.Cas(&s.sweepgen, sg-2, sg-1) {
			s.sweep(true)
			goto havespan
		}
	}
	...
}
```

å½“æ‰¾åˆ°éœ€è¦å›æ”¶çš„å†…å­˜å•å…ƒæ—¶ï¼Œè¿è¡Œæ—¶ä¼šè§¦å‘ [`runtime.mspan.sweep`](https://draveness.me/golang/tree/runtime.mspan.sweep) è¿›è¡Œæ¸…ç†ï¼Œå¦‚æœåœ¨åŒ…å«ç©ºé—²ç©ºé—´çš„é›†åˆä¸­æ²¡æœ‰æ‰¾åˆ°ç®¡ç†å•å…ƒï¼Œé‚£ä¹ˆè¿è¡Œæ—¶å°è¯•ä¼šä»æœªæ¸…ç†çš„é›†åˆä¸­è·å–ï¼š

```go
func (c *mcentral) cacheSpan() *mspan {
	...
	for ; spanBudget >= 0; spanBudget-- {
		s = c.fullUnswept(sg).pop()
		if s == nil {
			break
		}
		if atomic.Load(&s.sweepgen) == sg-2 && atomic.Cas(&s.sweepgen, sg-2, sg-1) {
 			s.sweep(true)
			freeIndex := s.nextFreeIndex()
			if freeIndex != s.nelems {
				s.freeindex = freeIndex
				goto havespan
			}
			c.fullSwept(sg).push(s)
		}
	}
	...
}
```

å¦‚æœ [`runtime.mcentral`](https://draveness.me/golang/tree/runtime.mcentral) é€šè¿‡ä¸Šè¿°ä¸¤ä¸ªé˜¶æ®µéƒ½æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„å•å…ƒï¼Œå®ƒä¼šè°ƒç”¨ [`runtime.mcentral.grow`](https://draveness.me/golang/tree/runtime.mcentral.grow) è§¦å‘æ‰©å®¹ä»å †ä¸­ç”³è¯·æ–°çš„å†…å­˜ï¼š

```go
func (c *mcentral) cacheSpan() *mspan {
	...
	s = c.grow()
	if s == nil {
		return nil
	}

havespan:
	freeByteBase := s.freeindex &^ (64 - 1)
	whichByte := freeByteBase / 8
	s.refillAllocCache(whichByte)

	s.allocCache >>= s.freeindex % 64

	return s
}
```

æ— è®ºé€šè¿‡å“ªç§æ–¹æ³•è·å–åˆ°äº†å†…å­˜å•å…ƒï¼Œè¯¥æ–¹æ³•çš„æœ€åéƒ½ä¼šæ›´æ–°å†…å­˜å•å…ƒçš„ `allocBits` å’Œ `allocCache` ç­‰å­—æ®µï¼Œè®©è¿è¡Œæ—¶åœ¨åˆ†é…å†…å­˜æ—¶èƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°ç©ºé—²çš„å¯¹è±¡ã€‚

##### æ‰©å®¹

ä¸­å¿ƒç¼“å­˜çš„æ‰©å®¹æ–¹æ³• [`runtime.mcentral.grow`](https://draveness.me/golang/tree/runtime.mcentral.grow) ä¼šæ ¹æ®é¢„å…ˆè®¡ç®—çš„ `class_to_allocnpages` å’Œ `class_to_size` è·å–å¾…åˆ†é…çš„é¡µæ•°ä»¥åŠè·¨åº¦ç±»å¹¶è°ƒç”¨ [`runtime.mheap.alloc`](https://draveness.me/golang/tree/runtime.mheap.alloc) è·å–æ–°çš„ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) ç»“æ„ï¼š

```go
// grow allocates a new empty span from the heap and initializes it for c's size class.
func (c *mcentral) grow() *mspan {
	npages := uintptr(class_to_allocnpages[c.spanclass.sizeclass()])
	size := uintptr(class_to_size[c.spanclass.sizeclass()])

	s := mheap_.alloc(npages, c.spanclass, true)
	if s == nil {
		return nil
	}

	// Use division by multiplication and shifts to quickly compute:
	// n := (npages << _PageShift) / size
	n := (npages << _PageShift) >> s.divShift * uintptr(s.divMul) >> s.divShift2
	s.limit = s.base() + size*n
	heapBitsForAddr(s.base()).initSpan(s)
	return s
}
```

è·å–äº† [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) åï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸Šè¿°æ–¹æ³•ä¸­åˆå§‹åŒ– `limit` å­—æ®µå¹¶æ¸…é™¤è¯¥ç»“æ„åœ¨å †ä¸Šå¯¹åº”çš„ä½å›¾ã€‚

#### é¡µå †

[`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap) æ˜¯å†…å­˜åˆ†é…çš„æ ¸å¿ƒç»“æ„ä½“ï¼ŒGo è¯­è¨€ç¨‹åºä¼šå°†å…¶ä½œä¸ºå…¨å±€å˜é‡å­˜å‚¨ï¼Œè€Œå †ä¸Šåˆå§‹åŒ–çš„æ‰€æœ‰å¯¹è±¡éƒ½ç”±è¯¥ç»“æ„ä½“ç»Ÿä¸€ç®¡ç†ï¼Œè¯¥ç»“æ„ä½“ä¸­åŒ…å«ä¸¤ç»„éå¸¸é‡è¦çš„å­—æ®µï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯å…¨å±€çš„ä¸­å¿ƒç¼“å­˜åˆ—è¡¨ `central`ï¼Œå¦ä¸€ä¸ªæ˜¯ç®¡ç†å †åŒºå†…å­˜åŒºåŸŸçš„ `arenas` ä»¥åŠç›¸å…³å­—æ®µã€‚

é¡µå †ä¸­åŒ…å«ä¸€ä¸ªé•¿åº¦ä¸º 136 çš„ [`runtime.mcentral`](https://draveness.me/golang/tree/runtime.mcentral) æ•°ç»„ï¼Œå…¶ä¸­ 68 ä¸ªä¸ºè·¨åº¦ç±»éœ€è¦ `scan` çš„ä¸­å¿ƒç¼“å­˜ï¼Œå¦å¤–çš„ 68 ä¸ªæ˜¯ `noscan` çš„ä¸­å¿ƒç¼“å­˜ï¼š

![mheap-and-mcentrals](../../../images/go/2020-02-29-15829868066525-mheap-and-mcentrals.png)

**å›¾ 7-17 é¡µå †ä¸ä¸­å¿ƒç¼“å­˜åˆ—è¡¨**

Go è¯­è¨€æ‰€æœ‰çš„å†…å­˜ç©ºé—´éƒ½ç”±å¦‚ä¸‹æ‰€ç¤ºçš„äºŒç»´çŸ©é˜µ [`runtime.heapArena`](https://draveness.me/golang/tree/runtime.heapArena) ç®¡ç†ï¼Œè¿™ä¸ªäºŒç»´çŸ©é˜µç®¡ç†çš„å†…å­˜å¯ä»¥æ˜¯ä¸è¿ç»­çš„ï¼š

![mheap-and-memories](../../../images/go/2020-02-29-15829868066531-mheap-and-memories.png)

**å›¾ 7-18 é¡µå †ç®¡ç†çš„å†…å­˜åŒºåŸŸ**

åœ¨é™¤äº† Windows ä»¥å¤–çš„ 64 ä½æ“ä½œç³»ç»Ÿä¸­ï¼Œæ¯ä¸€ä¸ª [`runtime.heapArena`](https://draveness.me/golang/tree/runtime.heapArena) éƒ½ä¼šç®¡ç† 64MB çš„å†…å­˜ç©ºé—´ï¼Œå¦‚ä¸‹æ‰€ç¤ºçš„è¡¨æ ¼å±•ç¤ºäº†ä¸åŒå¹³å°ä¸Š Go è¯­è¨€ç¨‹åºç®¡ç†çš„å †åŒºå¤§å°ä»¥åŠ [`runtime.heapArena`](https://draveness.me/golang/tree/runtime.heapArena) å ç”¨çš„å†…å­˜ç©ºé—´ï¼š

|           å¹³å° | åœ°å€ä½æ•° | Arena å¤§å° | ä¸€ç»´å¤§å° |   äºŒç»´å¤§å° |
| -------------: | -------: | ---------: | -------: | ---------: |
|       */64-bit |       48 |       64MB |        1 |  4M (32MB) |
| windows/64-bit |       48 |        4MB |       64 |   1M (8MB) |
|       */32-bit |       32 |        4MB |        1 | 1024 (4KB) |
|     */mips(le) |       31 |        4MB |        1 |  512 (2KB) |

**è¡¨ 7-3 å¹³å°ä¸é¡µå †å¤§å°çš„å…³ç³»**

##### åˆå§‹åŒ–

å †åŒºçš„åˆå§‹åŒ–ä¼šä½¿ç”¨ [`runtime.mheap.init`](https://draveness.me/golang/tree/runtime.mheap.init) æ–¹æ³•ï¼Œå…¶ä¸­åˆå§‹åŒ–çš„ä¸¤ç±»å˜é‡æ¯”è¾ƒé‡è¦ï¼š

1. `spanalloc`ã€`cachealloc` ä»¥åŠ `arenaHintAlloc` ç­‰ [`runtime.fixalloc`](https://draveness.me/golang/tree/runtime.fixalloc) ç±»å‹çš„ç©ºé—²é“¾è¡¨åˆ†é…å™¨ï¼›
2. `central` åˆ‡ç‰‡ä¸­ [`runtime.mcentral`](https://draveness.me/golang/tree/runtime.mcentral) ç±»å‹çš„ä¸­å¿ƒç¼“å­˜ï¼›

```go
// Initialize the heap.
func (h *mheap) init() {
	lockInit(&h.lock, lockRankMheap)
	lockInit(&h.speciallock, lockRankMheapSpecial)

	h.spanalloc.init(unsafe.Sizeof(mspan{}), recordspan, unsafe.Pointer(h), &memstats.mspan_sys)
	h.cachealloc.init(unsafe.Sizeof(mcache{}), nil, nil, &memstats.mcache_sys)
	h.specialfinalizeralloc.init(unsafe.Sizeof(specialfinalizer{}), nil, nil, &memstats.other_sys)
	h.specialprofilealloc.init(unsafe.Sizeof(specialprofile{}), nil, nil, &memstats.other_sys)
	h.arenaHintAlloc.init(unsafe.Sizeof(arenaHint{}), nil, nil, &memstats.other_sys)

	// Don't zero mspan allocations. Background sweeping can
	// inspect a span concurrently with allocating it, so it's
	// important that the span's sweepgen survive across freeing
	// and re-allocating a span to prevent background sweeping
	// from improperly cas'ing it from 0.
	//
	// This is safe because mspan contains no heap pointers.
	h.spanalloc.zero = false

	// h->mapcache needs no init

	for i := range h.central {
		h.central[i].mcentral.init(spanClass(i))
	}

	h.pages.init(&h.lock, &memstats.gcMiscSys)
}
```

å †ä¸­åˆå§‹åŒ–çš„å¤šä¸ªç©ºé—²é“¾è¡¨åˆ†é…å™¨ä¸è®¾è®¡åŸç†ä¸­æåˆ°çš„åˆ†é…å™¨æ²¡æœ‰å¤ªå¤šåŒºåˆ«ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ [`runtime.fixalloc.init`](https://draveness.me/golang/tree/runtime.fixalloc.init) åˆå§‹åŒ–åˆ†é…å™¨æ—¶ï¼Œéœ€è¦ä¼ å…¥å¾…åˆå§‹åŒ–çš„ç»“æ„ä½“å¤§å°ç­‰ä¿¡æ¯ï¼Œè¿™ä¼šå¸®åŠ©åˆ†é…å™¨åˆ†å‰²å¾…åˆ†é…çš„å†…å­˜ï¼Œå®ƒæä¾›äº†ä»¥ä¸‹ä¸¤ä¸ªç”¨äºåˆ†é…å’Œé‡Šæ”¾å†…å­˜çš„æ–¹æ³•ï¼š

1. [`runtime.fixalloc.alloc`](https://draveness.me/golang/tree/runtime.fixalloc.alloc) â€” è·å–ä¸‹ä¸€ä¸ªç©ºé—²çš„å†…å­˜ç©ºé—´ï¼›
2. [`runtime.fixalloc.free`](https://draveness.me/golang/tree/runtime.fixalloc.free) â€” é‡Šæ”¾æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ç©ºé—´ï¼›

è¯¥æ–¹æ³•è¿˜ä¼šåˆå§‹åŒ–æ‰€æœ‰çš„ä¸­å¿ƒç¼“å­˜ï¼Œè¿™äº›ä¸­å¿ƒç¼“å­˜ä¼šç»´æŠ¤å…¨å±€çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œå„ä¸ªçº¿ç¨‹ä¼šé€šè¿‡ä¸­å¿ƒç¼“å­˜è·å–æ–°çš„å†…å­˜å•å…ƒã€‚

##### å†…å­˜ç®¡ç†å•å…ƒ

[`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap) æ˜¯å†…å­˜åˆ†é…å™¨ä¸­çš„æ ¸å¿ƒç»„ä»¶ï¼Œè¿è¡Œæ—¶ä¼šé€šè¿‡å®ƒçš„ [`runtime.mheap.alloc`](https://draveness.me/golang/tree/runtime.mheap.alloc) æ–¹æ³•åœ¨ç³»ç»Ÿæ ˆä¸­è·å–æ–°çš„ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) å•å…ƒï¼š

```go
func (h *mheap) alloc(npages uintptr, spanclass spanClass, needzero bool) *mspan {
	var s *mspan
	systemstack(func() {
		if h.sweepdone == 0 {
			h.reclaim(npages)
		}
		s = h.allocSpan(npages, false, spanclass, &memstats.heap_inuse)
	})
	...
	return s
}
```

ä¸ºäº†é˜»æ­¢å†…å­˜çš„å¤§é‡å ç”¨å’Œå †çš„å¢é•¿ï¼Œæˆ‘ä»¬åœ¨åˆ†é…å¯¹åº”é¡µæ•°çš„å†…å­˜å‰éœ€è¦å…ˆè°ƒç”¨ [`runtime.mheap.reclaim`](https://draveness.me/golang/tree/runtime.mheap.reclaim) æ–¹æ³•å›æ”¶ä¸€éƒ¨åˆ†å†…å­˜ï¼Œéšåè¿è¡Œæ—¶é€šè¿‡ [`runtime.mheap.allocSpan`](https://draveness.me/golang/tree/runtime.mheap.allocSpan) åˆ†é…æ–°çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œè¯¥æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹å¯ä»¥æ‹†åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼š

1. ä»å †ä¸Šåˆ†é…æ–°çš„å†…å­˜é¡µå’Œå†…å­˜ç®¡ç†å•å…ƒ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ï¼›
2. åˆå§‹åŒ–å†…å­˜ç®¡ç†å•å…ƒå¹¶å°†å…¶åŠ å…¥ [`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap) æŒæœ‰å†…å­˜å•å…ƒåˆ—è¡¨ï¼›

é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨å †ä¸Šç”³è¯· `npages` æ•°é‡çš„å†…å­˜é¡µå¹¶åˆå§‹åŒ– [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ï¼š

```go
func (h *mheap) allocSpan(npages uintptr, typ spanAllocType, spanclass spanClass) (s *mspan) {
	gp := getg()
	base, scav := uintptr(0), uintptr(0)
	pp := gp.m.p.ptr()
	if pp != nil && npages < pageCachePages/4 {
		c := &pp.pcache
		base, scav = c.alloc(npages)
		if base != 0 {
			s = h.tryAllocMSpan()
			if s != nil && gcBlackenEnabled == 0 && (manual || spanclass.sizeclass() != 0) {
				goto HaveSpan
			}
		}
	}

	if base == 0 {
		base, scav = h.pages.alloc(npages)
		if base == 0 {
			h.grow(npages)
            base, scav = h.pages.alloc(npages)
			if base == 0 {
				throw("grew heap, but no adequate free space found")
			}
		}
	}
	if s == nil {
		s = h.allocMSpanLocked()
	}
	...
}
```

ä¸Šè¿°æ–¹æ³•ä¼šé€šè¿‡å¤„ç†å™¨çš„é¡µç¼“å­˜ [`runtime.pageCache`](https://draveness.me/golang/tree/runtime.pageCache) æˆ–è€…å…¨å±€çš„é¡µåˆ†é…å™¨ [`runtime.pageAlloc`](https://draveness.me/golang/tree/runtime.pageAlloc) ä¸¤ç§é€”å¾„ä»å †ä¸­ç”³è¯·å†…å­˜ï¼š

1. å¦‚æœç”³è¯·çš„å†…å­˜æ¯”è¾ƒå°ï¼Œè·å–ç”³è¯·å†…å­˜çš„å¤„ç†å™¨å¹¶å°è¯•è°ƒç”¨ [`runtime.pageCache.alloc`](https://draveness.me/golang/tree/runtime.pageCache.alloc) è·å–å†…å­˜åŒºåŸŸçš„åŸºåœ°å€å’Œå¤§å°ï¼›
2. å¦‚æœç”³è¯·çš„å†…å­˜æ¯”è¾ƒå¤§æˆ–è€…çº¿ç¨‹çš„é¡µç¼“å­˜ä¸­å†…å­˜ä¸è¶³ï¼Œä¼šé€šè¿‡ [`runtime.pageAlloc.alloc`](https://draveness.me/golang/tree/runtime.pageAlloc.alloc) åœ¨é¡µå †ä¸Šç”³è¯·å†…å­˜ï¼›
3. å¦‚æœå‘ç°é¡µå †ä¸Šçš„å†…å­˜ä¸è¶³ï¼Œä¼šå°è¯•é€šè¿‡ [`runtime.mheap.grow`](https://draveness.me/golang/tree/runtime.mheap.grow) æ‰©å®¹å¹¶é‡æ–°è°ƒç”¨ [`runtime.pageAlloc.alloc`](https://draveness.me/golang/tree/runtime.pageAlloc.alloc) ç”³è¯·å†…å­˜ï¼›
   1. å¦‚æœç”³è¯·åˆ°å†…å­˜ï¼Œæ„å‘³ç€æ‰©å®¹æˆåŠŸï¼›
   2. å¦‚æœæ²¡æœ‰ç”³è¯·åˆ°å†…å­˜ï¼Œæ„å‘³ç€æ‰©å®¹å¤±è´¥ï¼Œå®¿ä¸»æœºå¯èƒ½ä¸å­˜åœ¨ç©ºé—²å†…å­˜ï¼Œè¿è¡Œæ—¶ä¼šç›´æ¥ä¸­æ­¢å½“å‰ç¨‹åºï¼›

æ— è®ºé€šè¿‡å“ªç§æ–¹å¼è·å¾—å†…å­˜é¡µï¼Œæˆ‘ä»¬éƒ½ä¼šåœ¨è¯¥å‡½æ•°ä¸­åˆ†é…æ–°çš„ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) ç»“æ„ä½“ï¼›è¯¥æ–¹æ³•çš„å‰©ä½™éƒ¨åˆ†ä¼šé€šè¿‡é¡µæ•°ã€å†…å­˜ç©ºé—´ä»¥åŠè·¨åº¦ç±»ç­‰å‚æ•°åˆå§‹åŒ–å®ƒçš„å¤šä¸ªå­—æ®µï¼š

```go
func (h *mheap) alloc(npages uintptr, spanclass spanClass, needzero bool) *mspan {
	...
HaveSpan:
	s.init(base, npages)

	...

	s.freeindex = 0
	s.allocCache = ^uint64(0)
	s.gcmarkBits = newMarkBits(s.nelems)
	s.allocBits = newAllocBits(s.nelems)
	h.setSpans(s.base(), npages, s)
	return s
}
```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨ [`runtime.mspan.init`](https://draveness.me/golang/tree/runtime.mspan.init) è®¾ç½®å‚æ•°åˆå§‹åŒ–åˆšåˆšåˆ†é…çš„ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) ç»“æ„å¹¶é€šè¿‡ [`runtime.mheaps.setSpans`](https://draveness.me/golang/tree/runtime.mheaps.setSpans) å»ºç«‹é¡µå †ä¸å†…å­˜å•å…ƒçš„è”ç³»ã€‚

##### æ‰©å®¹

[`runtime.mheap.grow`](https://draveness.me/golang/tree/runtime.mheap.grow) ä¼šå‘æ“ä½œç³»ç»Ÿç”³è¯·æ›´å¤šçš„å†…å­˜ç©ºé—´ï¼Œä¼ å…¥çš„é¡µæ•°ç»è¿‡å¯¹é½å¯ä»¥å¾—åˆ°æœŸæœ›çš„å†…å­˜å¤§å°ï¼Œå¯ä»¥å°†è¯¥æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹åˆ†æˆä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

1. é€šè¿‡ä¼ å…¥çš„é¡µæ•°è·å–æœŸæœ›åˆ†é…çš„å†…å­˜ç©ºé—´å¤§å°ä»¥åŠå†…å­˜çš„åŸºåœ°å€ï¼›
2. å¦‚æœ `arena` åŒºåŸŸæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œè°ƒç”¨ [`runtime.mheap.sysAlloc`](https://draveness.me/golang/tree/runtime.mheap.sysAlloc) ä»æ“ä½œç³»ç»Ÿä¸­ç”³è¯·æ›´å¤šçš„å†…å­˜ï¼›
3. æ‰©å®¹ [`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap) æŒæœ‰çš„ `arena` åŒºåŸŸå¹¶æ›´æ–°é¡µåˆ†é…å™¨çš„å…ƒä¿¡æ¯ï¼›
4. åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œè°ƒç”¨ [`runtime.pageAlloc.scavenge`](https://draveness.me/golang/tree/runtime.pageAlloc.scavenge) å›æ”¶ä¸å†ä½¿ç”¨çš„ç©ºé—²å†…å­˜é¡µï¼›

åœ¨é¡µå †æ‰©å®¹çš„è¿‡ç¨‹ä¸­ï¼Œ[`runtime.mheap.sysAlloc`](https://draveness.me/golang/tree/runtime.mheap.sysAlloc) æ˜¯é¡µå †ç”¨æ¥ç”³è¯·è™šæ‹Ÿå†…å­˜çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ä¼šåˆ†å‡ éƒ¨åˆ†ä»‹ç»è¯¥æ–¹æ³•çš„å®ç°ã€‚

é¦–å…ˆï¼Œè¯¥æ–¹æ³•ä¼šå°è¯•åœ¨é¢„ä¿ç•™çš„åŒºåŸŸç”³è¯·å†…å­˜ï¼š

```go
func (h *mheap) sysAlloc(n uintptr) (v unsafe.Pointer, size uintptr) {
	n = alignUp(n, heapArenaBytes)

	v = h.arena.alloc(n, heapArenaBytes, &memstats.heap_sys)
	if v != nil {
		size = n
		goto mapped
	}
	...
}
```

ä¸Šè¿°ä»£ç ä¼šè°ƒç”¨çº¿æ€§åˆ†é…å™¨çš„ [`runtime.linearAlloc.alloc`](https://draveness.me/golang/tree/runtime.linearAlloc.alloc) åœ¨é¢„å…ˆä¿ç•™çš„å†…å­˜ä¸­ç”³è¯·ä¸€å—å¯ä»¥ä½¿ç”¨çš„ç©ºé—´ã€‚å¦‚æœæ²¡æœ‰å¯ç”¨çš„ç©ºé—´ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®é¡µå †çš„ `arenaHints` åœ¨ç›®æ ‡åœ°å€ä¸Šå°è¯•æ‰©å®¹ï¼š

```go
type mheap struct {
  ...
  // arenaHints is a list of addresses at which to attempt to
  // add more heap arenas. This is initially populated with a
  // set of general hint addresses, and grown with the bounds of
  // actual heap arena ranges.
  arenaHints *arenaHint
  ...
}

func (h *mheap) sysAlloc(n uintptr) (v unsafe.Pointer, size uintptr) {
	...
  // Try to grow the heap at a hint address.
	for h.arenaHints != nil {
		hint := h.arenaHints
		p := hint.addr
		v = sysReserve(unsafe.Pointer(p), n)
		if p == uintptr(v) {
      // Success. Update the hint.
			hint.addr = p
			size = n
			break
		}
    // Failed. Discard this hint and try the next.
		h.arenaHints = hint.next
		h.arenaHintAlloc.free(unsafe.Pointer(hint))
	}
	...
	sysMap(v, size, &memstats.heap_sys)
	...
}
```

[`runtime.sysReserve`](https://draveness.me/golang/tree/runtime.sysReserve) å’Œ [`runtime.sysMap`](https://draveness.me/golang/tree/runtime.sysMap) æ˜¯ä¸Šè¿°ä»£ç çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒä»¬ä¼šä»æ“ä½œç³»ç»Ÿä¸­ç”³è¯·å†…å­˜å¹¶å°†å†…å­˜è½¬æ¢è‡³ `Prepared` çŠ¶æ€ã€‚

```go
func (h *mheap) sysAlloc(n uintptr) (v unsafe.Pointer, size uintptr) {
	...
mapped:
	for ri := arenaIndex(uintptr(v)); ri <= arenaIndex(uintptr(v)+size-1); ri++ {
		l2 := h.arenas[ri.l1()]
		r := (*heapArena)(h.heapArenaAlloc.alloc(unsafe.Sizeof(*r), sys.PtrSize, &memstats.gc_sys))
		...
		h.allArenas = h.allArenas[:len(h.allArenas)+1]
		h.allArenas[len(h.allArenas)-1] = ri
		atomic.StorepNoWB(unsafe.Pointer(&l2[ri.l2()]), unsafe.Pointer(r))
	}
	return
}
```

[`runtime.mheap.sysAlloc`](https://draveness.me/golang/tree/runtime.mheap.sysAlloc) æ–¹æ³•åœ¨æœ€åä¼šåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ [`runtime.heapArena`](https://draveness.me/golang/tree/runtime.heapArena) æ¥ç®¡ç†åˆšåˆšç”³è¯·çš„å†…å­˜ç©ºé—´ï¼Œè¯¥ç»“æ„ä¼šè¢«åŠ å…¥é¡µå †çš„äºŒç»´çŸ©é˜µä¸­ã€‚

### å†…å­˜åˆ†é…

å †ä¸Šæ‰€æœ‰çš„å¯¹è±¡éƒ½ä¼šé€šè¿‡è°ƒç”¨ [`runtime.newobject`](https://draveness.me/golang/tree/runtime.newobject) å‡½æ•°åˆ†é…å†…å­˜ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨ [`runtime.mallocgc`](https://draveness.me/golang/tree/runtime.mallocgc) åˆ†é…æŒ‡å®šå¤§å°çš„å†…å­˜ç©ºé—´ï¼Œè¿™ä¹Ÿæ˜¯ç”¨æˆ·ç¨‹åºå‘å †ä¸Šç”³è¯·å†…å­˜ç©ºé—´çš„å¿…ç»å‡½æ•°ï¼š

```go
// Allocate an object of size bytes.
// Small objects are allocated from the per-P cache's free lists.
// Large objects (> 32 kB) are allocated straight from the heap.
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
	mp := acquirem()
	mp.mallocing = 1

	c := gomcache()
	var x unsafe.Pointer
	noscan := typ == nil || typ.ptrdata == 0
	if size <= maxSmallSize {
		if noscan && size < maxTinySize {
			// å¾®å¯¹è±¡åˆ†é…
		} else {
			// å°å¯¹è±¡åˆ†é…
		}
	} else {
		// å¤§å¯¹è±¡åˆ†é…
	}

	publicationBarrier()
	mp.mallocing = 0
	releasem(mp)

	return x
}
```

ä¸Šè¿°ä»£ç ä½¿ç”¨ [`runtime.gomcache`](https://draveness.me/golang/tree/runtime.gomcache) è·å–çº¿ç¨‹ç¼“å­˜å¹¶åˆ¤æ–­ç”³è¯·å†…å­˜çš„ç±»å‹æ˜¯å¦ä¸ºæŒ‡é’ˆã€‚æˆ‘ä»¬ä»è¿™ä¸ªä»£ç ç‰‡æ®µå¯ä»¥çœ‹å‡º [`runtime.mallocgc`](https://draveness.me/golang/tree/runtime.mallocgc) ä¼šæ ¹æ®å¯¹è±¡çš„å¤§å°æ‰§è¡Œä¸åŒçš„åˆ†é…é€»è¾‘ï¼Œè¿è¡Œæ—¶æ ¹æ®å¯¹è±¡å¤§å°å°†å®ƒä»¬åˆ†æˆå¾®å¯¹è±¡ã€å°å¯¹è±¡å’Œå¤§å¯¹è±¡ï¼Œè¿™é‡Œä¼šæ ¹æ®å¤§å°é€‰æ‹©ä¸åŒçš„åˆ†é…é€»è¾‘ï¼š

![allocator-and-memory-size](../../../images/go/2020-02-29-15829868066537-allocator-and-memory-size.png)

**å›¾ 7-19 ä¸‰ç§å¯¹è±¡**

- å¾®å¯¹è±¡ `(0, 16B)` â€” å…ˆä½¿ç”¨å¾®å‹åˆ†é…å™¨ï¼Œå†ä¾æ¬¡å°è¯•çº¿ç¨‹ç¼“å­˜ã€ä¸­å¿ƒç¼“å­˜å’Œå †åˆ†é…å†…å­˜ï¼›
- å°å¯¹è±¡ `[16B, 32KB]` â€” ä¾æ¬¡å°è¯•ä½¿ç”¨çº¿ç¨‹ç¼“å­˜ã€ä¸­å¿ƒç¼“å­˜å’Œå †åˆ†é…å†…å­˜ï¼›
- å¤§å¯¹è±¡ `(32KB, +âˆ)` â€” ç›´æ¥åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼›

#### å¾®å¯¹è±¡

Go è¯­è¨€è¿è¡Œæ—¶å°†å°äº 16 å­—èŠ‚çš„å¯¹è±¡åˆ’åˆ†ä¸ºå¾®å¯¹è±¡ï¼Œå®ƒä¼šä½¿ç”¨çº¿ç¨‹ç¼“å­˜ä¸Šçš„å¾®åˆ†é…å™¨æé«˜å¾®å¯¹è±¡åˆ†é…çš„æ€§èƒ½ï¼Œæˆ‘ä»¬ä¸»è¦ä½¿ç”¨å®ƒæ¥åˆ†é…è¾ƒå°çš„å­—ç¬¦ä¸²ä»¥åŠé€ƒé€¸çš„ä¸´æ—¶å˜é‡ã€‚å¾®åˆ†é…å™¨å¯ä»¥å°†å¤šä¸ªè¾ƒå°çš„å†…å­˜åˆ†é…è¯·æ±‚åˆå…¥åŒä¸€ä¸ªå†…å­˜å—ä¸­ï¼Œåªæœ‰å½“å†…å­˜å—ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½éœ€è¦è¢«å›æ”¶æ—¶ï¼Œæ•´ç‰‡å†…å­˜æ‰å¯èƒ½è¢«å›æ”¶ã€‚

å¾®åˆ†é…å™¨ç®¡ç†çš„å¯¹è±¡ä¸å¯ä»¥æ˜¯æŒ‡é’ˆç±»å‹ï¼Œç®¡ç†å¤šä¸ªå¯¹è±¡çš„å†…å­˜å—å¤§å° `maxTinySize` æ˜¯å¯ä»¥è°ƒæ•´çš„ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå†…å­˜å—çš„å¤§å°ä¸º 16 å­—èŠ‚ã€‚`maxTinySize` çš„å€¼è¶Šå¤§ï¼Œç»„åˆå¤šä¸ªå¯¹è±¡çš„å¯èƒ½æ€§å°±è¶Šé«˜ï¼Œå†…å­˜æµªè´¹ä¹Ÿå°±è¶Šä¸¥é‡ï¼›`maxTinySize` è¶Šå°ï¼Œå†…å­˜æµªè´¹å°±ä¼šè¶Šå°‘ï¼Œä¸è¿‡æ— è®ºå¦‚ä½•è°ƒæ•´ï¼Œ8 çš„å€æ•°éƒ½æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚

![tiny-allocator](../../../images/go/2020-02-29-15829868066543-tiny-allocator.png)

**å›¾ 7-20 å¾®åˆ†é…å™¨çš„å·¥ä½œåŸç†**

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¾®åˆ†é…å™¨å·²ç»åœ¨ 16 å­—èŠ‚çš„å†…å­˜å—ä¸­åˆ†é…äº† 12 å­—èŠ‚çš„å¯¹è±¡ï¼Œå¦‚æœä¸‹ä¸€ä¸ªå¾…åˆ†é…çš„å¯¹è±¡å°äº 4 å­—èŠ‚ï¼Œå®ƒä¼šç›´æ¥ä½¿ç”¨ä¸Šè¿°å†…å­˜å—çš„å‰©ä½™éƒ¨åˆ†ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ï¼Œä¸è¿‡è¯¥å†…å­˜å—åªæœ‰æ‰€æœ‰å¯¹è±¡éƒ½è¢«æ ‡è®°ä¸ºåƒåœ¾æ—¶æ‰ä¼šå›æ”¶ã€‚

çº¿ç¨‹ç¼“å­˜ [`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache) ä¸­çš„ `tiny` å­—æ®µæŒ‡å‘äº† `maxTinySize` å¤§å°çš„å—ï¼Œå¦‚æœå½“å‰å—ä¸­è¿˜åŒ…å«å¤§å°åˆé€‚çš„ç©ºé—²å†…å­˜ï¼Œè¿è¡Œæ—¶ä¼šé€šè¿‡åŸºåœ°å€å’Œåç§»é‡è·å–å¹¶è¿”å›è¿™å—å†…å­˜ï¼š

```go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
	...
	if size <= maxSmallSize {
		if noscan && size < maxTinySize {
			off := c.tinyoffset
			if off+size <= maxTinySize && c.tiny != 0 {
				x = unsafe.Pointer(c.tiny + off)
				c.tinyoffset = off + size
				c.local_tinyallocs++
				releasem(mp)
				return x
			}
			...
		}
		...
	}
	...
}
```

å½“å†…å­˜å—ä¸­ä¸åŒ…å«ç©ºé—²çš„å†…å­˜æ—¶ï¼Œä¸‹é¢çš„è¿™æ®µä»£ç ä¼šå…ˆä»çº¿ç¨‹ç¼“å­˜æ‰¾åˆ°è·¨åº¦ç±»å¯¹åº”çš„å†…å­˜ç®¡ç†å•å…ƒ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ï¼Œè°ƒç”¨ [`runtime.nextFreeFast`](https://draveness.me/golang/tree/runtime.nextFreeFast) è·å–ç©ºé—²çš„å†…å­˜ï¼›å½“ä¸å­˜åœ¨ç©ºé—²å†…å­˜æ—¶ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ [`runtime.mcache.nextFree`](https://draveness.me/golang/tree/runtime.mcache.nextFree) ä»ä¸­å¿ƒç¼“å­˜æˆ–è€…é¡µå †ä¸­è·å–å¯åˆ†é…çš„å†…å­˜å—ï¼š

```go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
	...
	if size <= maxSmallSize {
		if noscan && size < maxTinySize {
			...
			span := c.alloc[tinySpanClass]
			v := nextFreeFast(span)
			if v == 0 {
				v, _, _ = c.nextFree(tinySpanClass)
			}
			x = unsafe.Pointer(v)
			(*[2]uint64)(x)[0] = 0
			(*[2]uint64)(x)[1] = 0
			if size < c.tinyoffset || c.tiny == 0 {
				c.tiny = uintptr(x)
				c.tinyoffset = size
			}
			size = maxTinySize
		}
		...
	}
	...
	return x
}
```

è·å–æ–°çš„ç©ºé—²å†…å­˜å—ä¹‹åï¼Œä¸Šè¿°ä»£ç ä¼šæ¸…ç©ºç©ºé—²å†…å­˜ä¸­çš„æ•°æ®ã€æ›´æ–°æ„æˆå¾®å¯¹è±¡åˆ†é…å™¨çš„å‡ ä¸ªå­—æ®µ `tiny` å’Œ `tinyoffset` å¹¶è¿”å›æ–°çš„ç©ºé—²å†…å­˜ã€‚

#### å°å¯¹è±¡

å°å¯¹è±¡æ˜¯æŒ‡å¤§å°ä¸º 16 å­—èŠ‚åˆ° 32,768 å­—èŠ‚çš„å¯¹è±¡ä»¥åŠæ‰€æœ‰å°äº 16 å­—èŠ‚çš„æŒ‡é’ˆç±»å‹çš„å¯¹è±¡ï¼Œå°å¯¹è±¡çš„åˆ†é…å¯ä»¥è¢«åˆ†æˆä»¥ä¸‹çš„ä¸‰ä¸ªæ­¥éª¤ï¼š

1. ç¡®å®šåˆ†é…å¯¹è±¡çš„å¤§å°ä»¥åŠè·¨åº¦ç±» [`runtime.spanClass`](https://draveness.me/golang/tree/runtime.spanClass)ï¼›
2. ä»çº¿ç¨‹ç¼“å­˜ã€ä¸­å¿ƒç¼“å­˜æˆ–è€…å †ä¸­è·å–å†…å­˜ç®¡ç†å•å…ƒå¹¶ä»å†…å­˜ç®¡ç†å•å…ƒæ‰¾åˆ°ç©ºé—²çš„å†…å­˜ç©ºé—´ï¼›
3. è°ƒç”¨ [`runtime.memclrNoHeapPointers`](https://draveness.me/golang/tree/runtime.memclrNoHeapPointers) æ¸…ç©ºç©ºé—²å†…å­˜ä¸­çš„æ‰€æœ‰æ•°æ®ï¼›

ç¡®å®šå¾…åˆ†é…çš„å¯¹è±¡å¤§å°ä»¥åŠè·¨åº¦ç±»éœ€è¦ä½¿ç”¨é¢„å…ˆè®¡ç®—å¥½çš„ `size_to_class8`ã€`size_to_class128` ä»¥åŠ `class_to_size` å­—å…¸ï¼Œè¿™äº›å­—å…¸èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿè·å–å¯¹åº”çš„å€¼å¹¶æ„å»º [`runtime.spanClass`](https://draveness.me/golang/tree/runtime.spanClass)ï¼š

```go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
	...
	if size <= maxSmallSize {
		...
		} else {
			var sizeclass uint8
			if size <= smallSizeMax-8 {
				sizeclass = size_to_class8[(size+smallSizeDiv-1)/smallSizeDiv]
			} else {
				sizeclass = size_to_class128[(size-smallSizeMax+largeSizeDiv-1)/largeSizeDiv]
			}
			size = uintptr(class_to_size[sizeclass])
			spc := makeSpanClass(sizeclass, noscan)
			span := c.alloc[spc]
			v := nextFreeFast(span)
			if v == 0 {
				v, span, _ = c.nextFree(spc)
			}
			x = unsafe.Pointer(v)
			if needzero && span.needzero != 0 {
				memclrNoHeapPointers(unsafe.Pointer(v), size)
			}
		}
	} else {
		...
	}
	...
	return x
}
```

[`runtime.nextFreeFast`](https://draveness.me/golang/tree/runtime.nextFreeFast) ä¼šåˆ©ç”¨å†…å­˜ç®¡ç†å•å…ƒä¸­çš„ `allocCache` å­—æ®µï¼Œå¿«é€Ÿæ‰¾åˆ°è¯¥å­—æ®µä¸º 1 çš„ä½æ•°ï¼Œ 1 è¡¨ç¤ºè¯¥ä½å¯¹åº”çš„å†…å­˜ç©ºé—´æ˜¯ç©ºé—²çš„ï¼š

```go
func nextFreeFast(s *mspan) gclinkptr {
	theBit := sys.Ctz64(s.allocCache)
	if theBit < 64 {
		result := s.freeindex + uintptr(theBit)
		if result < s.nelems {
			freeidx := result + 1
			if freeidx%64 == 0 && freeidx != s.nelems {
				return 0
			}
			s.allocCache >>= uint(theBit + 1)
			s.freeindex = freeidx
			s.allocCount++
			return gclinkptr(result*s.elemsize + s.base())
		}
	}
	return 0
}
```

æ‰¾åˆ°äº†ç©ºé—²çš„å¯¹è±¡åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ›´æ–°å†…å­˜ç®¡ç†å•å…ƒçš„ `allocCache`ã€`freeindex` ç­‰å­—æ®µå¹¶è¿”å›è¯¥ç‰‡å†…å­˜ï¼›å¦‚æœæˆ‘ä»¬æ²¡æœ‰æ‰¾åˆ°ç©ºé—²çš„å†…å­˜ï¼Œè¿è¡Œæ—¶ä¼šé€šè¿‡ [`runtime.mcache.nextFree`](https://draveness.me/golang/tree/runtime.mcache.nextFree) æ‰¾åˆ°æ–°çš„å†…å­˜ç®¡ç†å•å…ƒï¼š

```go
func (c *mcache) nextFree(spc spanClass) (v gclinkptr, s *mspan, shouldhelpgc bool) {
	s = c.alloc[spc]
	freeIndex := s.nextFreeIndex()
	if freeIndex == s.nelems {
		c.refill(spc)
		s = c.alloc[spc]
		freeIndex = s.nextFreeIndex()
	}

	v = gclinkptr(freeIndex*s.elemsize + s.base())
	s.allocCount++
	return
}
```

åœ¨ä¸Šè¿°æ–¹æ³•ä¸­ï¼Œå¦‚æœæˆ‘ä»¬åœ¨çº¿ç¨‹ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œä¼šé€šè¿‡å‰é¢ä»‹ç»çš„ [`runtime.mcache.refill`](https://draveness.me/golang/tree/runtime.mcache.refill) ä½¿ç”¨ä¸­å¿ƒç¼“å­˜ä¸­çš„å†…å­˜ç®¡ç†å•å…ƒæ›¿æ¢å·²ç»ä¸å­˜åœ¨å¯ç”¨å¯¹è±¡çš„ç»“æ„ä½“ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨æ–°ç»“æ„ä½“çš„ [`runtime.mspan.nextFreeIndex`](https://draveness.me/golang/tree/runtime.mspan.nextFreeIndex) è·å–ç©ºé—²çš„å†…å­˜å¹¶è¿”å›ã€‚

#### å¤§å¯¹è±¡

è¿è¡Œæ—¶å¯¹äºå¤§äº 32KB çš„å¤§å¯¹è±¡ä¼šå•ç‹¬å¤„ç†ï¼Œæˆ‘ä»¬ä¸ä¼šä»çº¿ç¨‹ç¼“å­˜æˆ–è€…ä¸­å¿ƒç¼“å­˜ä¸­è·å–å†…å­˜ç®¡ç†å•å…ƒï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ [`runtime.mcache.allocLarge`](https://draveness.me/golang/tree/runtime.mcache.allocLarge) åˆ†é…å¤§ç‰‡å†…å­˜ï¼š

```go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
	...
	if size <= maxSmallSize {
		...
	} else {
		var s *mspan
		span = c.allocLarge(size, needzero, noscan)
		span.freeindex = 1
		span.allocCount = 1
		x = unsafe.Pointer(span.base())
		size = span.elemsize
	}

	publicationBarrier()
	mp.mallocing = 0
	releasem(mp)

	return x
}
```

[`runtime.mcache.allocLarge`](https://draveness.me/golang/tree/runtime.mcache.allocLarge) ä¼šè®¡ç®—åˆ†é…è¯¥å¯¹è±¡æ‰€éœ€è¦çš„é¡µæ•°ï¼Œå®ƒæŒ‰ç…§ 8KB çš„å€æ•°åœ¨å †ä¸Šç”³è¯·å†…å­˜ï¼š

```go
func (c *mcache) allocLarge(size uintptr, needzero bool, noscan bool) *mspan {
	npages := size >> _PageShift
	if size&_PageMask != 0 {
		npages++
	}
	...
	s := mheap_.alloc(npages, spc, needzero)
	mheap_.central[spc].mcentral.fullSwept(mheap_.sweepgen).push(s)
	s.limit = s.base() + size
	heapBitsForAddr(s.base()).initSpan(s)
	return s
}
```

ç”³è¯·å†…å­˜æ—¶ä¼šåˆ›å»ºä¸€ä¸ªè·¨åº¦ç±»ä¸º 0 çš„ [`runtime.spanClass`](https://draveness.me/golang/tree/runtime.spanClass) å¹¶è°ƒç”¨ [`runtime.mheap.alloc`](https://draveness.me/golang/tree/runtime.mheap.alloc) åˆ†é…ä¸€ä¸ªç®¡ç†å¯¹åº”å†…å­˜çš„ç®¡ç†å•å…ƒã€‚

### å°ç»“

å†…å­˜åˆ†é…æ˜¯ Go è¯­è¨€è¿è¡Œæ—¶å†…å­˜ç®¡ç†çš„æ ¸å¿ƒé€»è¾‘ï¼Œè¿è¡Œæ—¶çš„å†…å­˜åˆ†é…å™¨ä½¿ç”¨ç±»ä¼¼ TCMalloc çš„åˆ†é…ç­–ç•¥å°†å¯¹è±¡æ ¹æ®å¤§å°åˆ†ç±»ï¼Œå¹¶è®¾è®¡å¤šå±‚çº§çš„ç»„ä»¶æé«˜å†…å­˜åˆ†é…å™¨çš„æ€§èƒ½ã€‚

### å†å²å˜æ›´ 

- 2020-01-24 æ›´æ–°ï¼š
  1. Go 1.15 - å®ç°æ–°çš„ [`runtime.mcentral`](https://draveness.me/golang/tree/runtime.mcentral) ç”¨äºè§£å†³é”ç«äº‰å’Œå†…å­˜ç®¡ç†å•å…ƒçš„æ‰€æœ‰æƒé—®é¢˜ï¼Œæé«˜å†…å­˜åˆ†é…çš„æ€§èƒ½[9](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#fn:9)ï¼›
  2. Go 1.16 - å¢åŠ äº† 24 å­—èŠ‚çš„è·¨åº¦ç±»ç”¨äºå­˜å‚¨ 64 ä½æ“ä½œç³»ç»Ÿä¸Šçš„ 3 ä¸ªæŒ‡é’ˆï¼Œè·¨åº¦ç±»æ€»æ•°ä» 66 å¢åŠ åˆ° 67[10](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#fn:10)ï¼›
